<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>接入号编码签名报备 - 列表</title>
  <style>
    :root{
      --bg:#f5f7fb;
      --card:#fff;
      --text:#1f2937;
      --muted:#6b7280;
      --line:#e5e7eb;
      --primary:#10b981;
      --primary-2:#0ea371;
      --danger:#ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius: 10px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
      color:var(--text);
      background:var(--bg);
    }
    .page{
      max-width: 1360px;
      margin: 24px auto;
      padding: 0 16px 40px;
    }

    /* Toolbar & Filter */
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .filter{
      padding: 16px 16px 10px;
    }
    .filter-grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(220px, 1fr));
      gap: 12px 16px;
      align-items:end;
    }
    .field label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 6px;
    }
    .input, .select, .textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius: 8px;
      padding: 10px 12px;
      background:#fff;
      outline:none;
      font-size: 13px;
    }
    .textarea{ min-height: 38px; resize: vertical; }
    .input:focus, .select:focus, .textarea:focus{
      border-color: rgba(16,185,129,.6);
      box-shadow: 0 0 0 3px rgba(16,185,129,.15);
    }
    .actions-row{
      display:flex;
      gap: 10px;
      justify-content:flex-end;
      padding: 10px 16px 16px;
      border-top: 1px dashed var(--line);
    }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      color: var(--text);
      border-radius: 8px;
      padding: 9px 14px;
      font-size: 13px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn:hover{ background:#f9fafb; }
    .btn-primary{
      border-color: transparent;
      background: var(--primary);
      color:#fff;
    }
    .btn-primary:hover{ background: var(--primary-2); }
    .btn-ghost{
      background: transparent;
    }
    .btn-danger{
      border-color: rgba(239,68,68,.25);
      color: var(--danger);
      background: rgba(239,68,68,.06);
    }
    .btn-danger:hover{ background: rgba(239,68,68,.10); }
    .toolbar{
      display:flex;
      gap: 10px;
      padding: 14px 16px;
      border-top: 1px solid var(--line);
      border-bottom: 1px solid var(--line);
      background: linear-gradient(#fff,#fff);
      position: sticky;
      top: 0;
      z-index: 5;
      border-radius: var(--radius) var(--radius) 0 0;
    }

    /* Table */
    .table-wrap{
      overflow:auto;
      border-radius: 0 0 var(--radius) var(--radius);
    }
    table{
      width: 100%;
      border-collapse: collapse;
      min-width: 1250px;
    }
    thead th{
      background: #fff;
      z-index: 2;
      border-bottom: 1px solid var(--line);
      font-size: 12px;
      color: #374151;
      text-align:left;
      padding: 12px 12px;
      white-space: nowrap;
    }
    tbody td{
      border-bottom: 1px solid var(--line);
      font-size: 13px;
      padding: 12px 12px;
      vertical-align: top;
      white-space: nowrap;
    }
    tbody tr:hover{ background: #f9fafb; }
    .muted{ color: var(--muted); }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid var(--line);
      background:#fff;
    }
    .pill.on{ border-color: rgba(16,185,129,.35); background: rgba(16,185,129,.08); color: #0f766e; }
    .pill.off{ border-color: rgba(107,114,128,.35); background: rgba(107,114,128,.08); color: #374151; }
    .ops{
      display:flex;
      gap: 8px;
    }
    .link{
      color: #2563eb;
      text-decoration: none;
    }
    .link:hover{ text-decoration: underline; }

    /* Modal */
    .modal-mask{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 20;
    }
    .modal{
      width: min(860px, 96vw);
      background:#fff;
      border-radius: 12px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(229,231,235,.8);
      overflow:hidden;
    }
    .modal-header{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--line);
    }
    .modal-title{
      font-weight: 600;
    }
    .modal-close{
      border:none;
      background:transparent;
      font-size: 18px;
      cursor:pointer;
      color: var(--muted);
    }
    .modal-body{
      padding: 16px;
    }
    .modal-footer{
      padding: 14px 16px;
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      border-top:1px solid var(--line);
      background:#fff;
    }
    .form-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(240px, 1fr));
      gap: 12px 16px;
    }
    .field-inline{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .hint{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.6;
    }
    .hint ul{ margin: 6px 0 0 18px; }

    /* Multi-select style */
    .chips{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 8px 10px;
      border:1px solid var(--line);
      border-radius: 8px;
      min-height: 40px;
      background:#fff;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 12px;
      background:#fff;
    }
    .chip button{
      border:none;
      background:transparent;
      cursor:pointer;
      color: var(--muted);
      font-size: 14px;
      line-height: 1;
    }
    .select-row{
      display:flex;
      gap: 10px;
      align-items:center;
    }
    .select-row .select{ flex:1; }

    @media (max-width: 1100px){
      .filter-grid{ grid-template-columns: repeat(2, minmax(220px, 1fr)); }
      thead th{ top: 62px; }
      .form-grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="page">

    <!-- Filter Card -->
    <div class="card">
      <div class="filter">
        <div class="filter-grid">
          <div class="field">
            <label>通道编码（精准）</label>
            <input id="f_channel" class="input" placeholder="请输入通道编码" />
          </div>
          <div class="field">
            <label>签名（模糊）</label>
            <input id="f_signature" class="input" placeholder="请输入签名关键字" />
          </div>
          <div class="field">
            <label>扩展码（精准）</label>
            <input id="f_ext" class="input" placeholder="请输入扩展码" />
          </div>
          <div class="field">
            <label>手机号（精准）</label>
            <input id="f_phone" class="input" placeholder="请输入手机号" />
          </div>

          <div class="field">
            <label>链接（模糊）</label>
            <input id="f_link" class="input" placeholder="请输入链接关键字" />
          </div>
          <div class="field">
            <label>发送类型</label>
            <select id="f_sendType" class="select">
              <option value="">全部</option>
              <option value="行销">行销</option>
              <option value="行业">行业</option>
              <option value="营销">营销</option>
            </select>
          </div>
          <div class="field">
            <label class="muted"> </label>
            <div class="muted" style="font-size:12px; padding:10px 0;">
              支持：精准/模糊筛选（按你的定义）
            </div>
          </div>
          <div class="field">
            <label class="muted"> </label>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
              <button class="btn btn-primary" id="btn_search">查询</button>
              <button class="btn" id="btn_reset">重置</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Toolbar -->
      <div class="toolbar">
        <button class="btn btn-primary" id="btn_import">导入</button>
        <button class="btn" id="btn_export" title="演示：导出当前筛选结果为 CSV">导出</button>
        <div style="flex:1"></div>
        <div class="muted" style="font-size:12px; display:flex; align-items:center;">
          数据条数：<span id="count" style="margin-left:6px; font-weight:600; color:#111827;">0</span>
        </div>
      </div>

      <!-- Table -->
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:64px;">序号</th>
              <th>通道编码</th>
              <th>接入号编码</th>
              <th>签名</th>
              <th>扩展码</th>
              <th>手机号</th>
              <th>链接</th>
              <th>发送类型</th>
              <th>是否启用</th>
              <th>备注</th>
              <th>任务ID</th>
              <th>操作时间</th>
              <th style="width:140px;">操作</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div class="modal-mask" id="importMask" aria-hidden="true">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">导入</div>
        <button class="modal-close" data-close="importMask">✕</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="field">
            <label>选择通道编码（多选）</label>
            <div class="select-row">
              <select id="import_channel_select" class="select">
                <option value="" selected>请选择</option>
              </select>
              <button class="btn" id="import_add_channel">添加</button>
            </div>
            <div class="chips" id="import_channel_chips"></div>
          </div>

          <div class="field">
            <label>选择账号（多选）</label>
            <div class="select-row">
              <select id="import_account_select" class="select">
                <option value="" selected>请选择</option>
                <option value="账号A">账号A</option>
                <option value="账号B">账号B</option>
                <option value="账号C">账号C</option>
              </select>
              <button class="btn" id="import_add_account">添加</button>
            </div>
            <div class="chips" id="import_account_chips"></div>
          </div>

          <div class="field" style="grid-column: 1 / -1;">
            <label>导入文件</label>
            <input id="import_file" type="file" class="input" accept=".xlsx,.xls,.csv" />
            <div class="hint">
              点击下载：<a class="link" href="javascript:void(0)" id="download_tpl">接入号编码报备范例.xlsx</a>
              <ul>
                <li>请上传 xlsx/xls/csv 格式（演示页面不解析，仅做交互展示）</li>
                <li>excel 单元格格式请勿使用“常规”或“文本”以外格式（提示文案示意）</li>
                <li>单次导入建议不超过 10000 条（提示文案示意）</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" data-close="importMask">取消</button>
        <button class="btn btn-primary" id="import_submit">提交</button>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal-mask" id="editMask" aria-hidden="true">
    <div class="modal" style="width:min(720px, 96vw);">
      <div class="modal-header">
        <div class="modal-title">编辑</div>
        <button class="modal-close" data-close="editMask">✕</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="field">
            <label>接入号编码（不可编辑）</label>
            <input id="e_accessNo" class="input" disabled />
          </div>
          <div class="field">
            <label>签名（不可编辑）</label>
            <input id="e_signature" class="input" disabled />
          </div>
          <div class="field">
            <label>扩展码（不可编辑）</label>
            <input id="e_ext" class="input" disabled />
          </div>

          <div class="field">
            <label>发送类型（可编辑）</label>
            <select id="e_sendType" class="select">
              <option value="行销">行销</option>
              <option value="行业">行业</option>
              <option value="营销">营销</option>
            </select>
          </div>

          <div class="field">
            <label>是否启用（可编辑）</label>
            <select id="e_enabled" class="select">
              <option value="true">是</option>
              <option value="false">否</option>
            </select>
          </div>

          <div class="field" style="grid-column: 1 / -1;">
            <label>备注（可编辑）</label>
            <textarea id="e_remark" class="textarea" placeholder="请输入备注（可选）" maxlength="50"></textarea>
            <div class="muted" style="font-size:12px; margin-top:6px; text-align:right;">
              <span id="remarkCount">0</span>/50
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" data-close="editMask">取消</button>
        <button class="btn btn-primary" id="edit_save">确定</button>
      </div>
    </div>
  </div>

  <script>
    // --------------------------
    // Mock data (示例数据)
    // --------------------------
    const DATA = [
      {
        id: crypto.randomUUID(),
        channelCode: "YZ",
        accessNoCode: "1QG106828164",
        signature: "【鹿城区南浦李金燕服装店】",
        extCode: "8000102068",
        phone: "13800001111",
        link: "https://example.com/a?src=yz",
        sendType: "行销",
        enabled: true,
        remark: "首批导入",
        taskId: "T-20251230-001",
        opTime: "2025-12-30 10:18:22",
      },
      {
        id: crypto.randomUUID(),
        channelCode: "YZ",
        accessNoCode: "1QG106848241",
        signature: "【鹿城区南浦李金燕服装店】",
        extCode: "8000102068",
        phone: "13800002222",
        link: "https://example.com/b",
        sendType: "行业",
        enabled: false,
        remark: "",
        taskId: "T-20251230-002",
        opTime: "2025-12-30 11:02:09",
      },
      {
        id: crypto.randomUUID(),
        channelCode: "DX",
        accessNoCode: "AC-99887766",
        signature: "【XX有限公司】",
        extCode: "9000100001",
        phone: "13912345678",
        link: "https://landing.example.com/promo",
        sendType: "营销",
        enabled: true,
        remark: "渠道DX测试",
        taskId: "T-20251229-009",
        opTime: "2025-12-29 16:44:01",
      },
      {
        id: crypto.randomUUID(),
        channelCode: "LT",
        accessNoCode: "LT-11223344",
        signature: "【某门店】",
        extCode: "7000123456",
        phone: "13711112222",
        link: "https://example.com/store",
        sendType: "行销",
        enabled: true,
        remark: "长期",
        taskId: "T-20251228-003",
        opTime: "2025-12-28 09:12:45",
      }
    ];

    let state = {
      rows: [...DATA],
      filtered: [],
      editingId: null,
      importChannels: [],
      importAccounts: []
    };

    // --------------------------
    // Helpers
    // --------------------------
    const $ = (id) => document.getElementById(id);

    function contains(hay, needle){
      return String(hay ?? "").toLowerCase().includes(String(needle ?? "").toLowerCase());
    }
    function equals(a,b){
      return String(a ?? "") === String(b ?? "");
    }
    function fmtEnabled(v){
      return v ? `<span class="pill on">启用</span>` : `<span class="pill off">停用</span>`;
    }

    // --------------------------
    // Render
    // --------------------------
    function renderTable(rows){
      const tbody = $("tbody");
      tbody.innerHTML = rows.map((r, idx) => `
        <tr data-id="${r.id}">
          <td>${idx + 1}</td>
          <td>${r.channelCode}</td>
          <td>${r.accessNoCode}</td>
          <td title="${escapeHtml(r.signature)}">${escapeHtml(r.signature)}</td>
          <td>${r.extCode}</td>
          <td>${r.phone}</td>
          <td title="${escapeHtml(r.link)}">
            <a class="link" href="${escapeAttr(r.link)}" target="_blank" rel="noreferrer">${escapeHtml(shorten(r.link, 28))}</a>
          </td>
          <td>${r.sendType}</td>
          <td>${fmtEnabled(r.enabled)}</td>
          <td title="${escapeHtml(r.remark || "-")}">${escapeHtml(r.remark || "-")}</td>
          <td>${escapeHtml(r.taskId || "-")}</td>
          <td>${escapeHtml(r.opTime || "-")}</td>
          <td>
            <div class="ops">
              <button class="btn btn-ghost" data-op="edit">编辑</button>
              <button class="btn btn-danger" data-op="del">删除</button>
            </div>
          </td>
        </tr>
      `).join("");

      $("count").textContent = rows.length;
    }

    function shorten(s, n){
      s = String(s || "");
      if(s.length <= n) return s;
      return s.slice(0, n-1) + "…";
    }

    // basic escaping
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(str){ return escapeHtml(str); }

    // --------------------------
    // Filtering logic (按你的定义：精准 / 模糊)
    // --------------------------
    function applyFilters(){
      const fChannel = $("f_channel").value.trim();
      const fSign = $("f_signature").value.trim();
      const fExt = $("f_ext").value.trim();
      const fPhone = $("f_phone").value.trim();
      const fLink = $("f_link").value.trim();
      const fSend = $("f_sendType").value.trim(); // '' means all

      const rows = state.rows.filter(r => {
        if (fChannel && !equals(r.channelCode, fChannel)) return false;           // 通道编码精准
        if (fExt && !equals(r.extCode, fExt)) return false;                       // 扩展码精准
        if (fPhone && !equals(r.phone, fPhone)) return false;                     // 手机号精准
        if (fSend && !equals(r.sendType, fSend)) return false;                    // 发送类型下拉
        if (fSign && !contains(r.signature, fSign)) return false;                 // 签名模糊
        if (fLink && !contains(r.link, fLink)) return false;                      // 链接模糊
        return true;
      });

      state.filtered = rows;
      renderTable(rows);
    }

    function resetFilters(){
      $("f_channel").value = "";
      $("f_signature").value = "";
      $("f_ext").value = "";
      $("f_phone").value = "";
      $("f_link").value = "";
      $("f_sendType").value = "";
      applyFilters();
    }

    // --------------------------
    // Modals
    // --------------------------
    function openModal(maskId){
      const el = $(maskId);
      el.style.display = "flex";
      el.setAttribute("aria-hidden","false");
    }
    function closeModal(maskId){
      const el = $(maskId);
      el.style.display = "none";
      el.setAttribute("aria-hidden","true");
    }

    // --------------------------
    // Edit flow
    // --------------------------
    function openEdit(id){
      const row = state.rows.find(x => x.id === id);
      if(!row) return;

      state.editingId = id;

      $("e_accessNo").value = row.accessNoCode;
      $("e_signature").value = row.signature;
      $("e_ext").value = row.extCode;
      $("e_sendType").value = row.sendType;
      $("e_enabled").value = String(row.enabled);
      $("e_remark").value = row.remark || "";
      $("remarkCount").textContent = ($("e_remark").value || "").length;

      openModal("editMask");
    }

    function saveEdit(){
      const id = state.editingId;
      const idx = state.rows.findIndex(x => x.id === id);
      if(idx < 0) return;

      // 可编辑字段：发送类型 / 是否启用 / 备注
      state.rows[idx].sendType = $("e_sendType").value;
      state.rows[idx].enabled = $("e_enabled").value === "true";
      state.rows[idx].remark = $("e_remark").value.trim();

      // 操作时间更新（示例）
      state.rows[idx].opTime = new Date().toISOString().slice(0,19).replace("T"," ");

      closeModal("editMask");
      applyFilters();
    }

    // --------------------------
    // Delete flow
    // --------------------------
    function deleteRow(id){
      const row = state.rows.find(x => x.id === id);
      if(!row) return;

      const ok = confirm(`确认删除？\n接入号编码：${row.accessNoCode}\n签名：${row.signature}`);
      if(!ok) return;

      state.rows = state.rows.filter(x => x.id !== id);
      applyFilters();
    }

    // --------------------------
    // Import flow (UI-only demo)
    // --------------------------
    function initImportOptions(){
      // 通道编码下拉来源：从现有数据里去重
      const channels = Array.from(new Set(state.rows.map(r => r.channelCode))).sort();
      const sel = $("import_channel_select");
      sel.innerHTML = `<option value="" selected>请选择</option>` + channels.map(c => `<option value="${escapeAttr(c)}">${escapeHtml(c)}</option>`).join("");
    }

    function renderChips(containerId, items, onRemove){
      const el = $(containerId);
      if(items.length === 0){
        el.innerHTML = `<span class="muted" style="font-size:12px;">未选择</span>`;
        return;
      }
      el.innerHTML = items.map(v => `
        <span class="chip">
          ${escapeHtml(v)}
          <button title="移除" data-val="${escapeAttr(v)}">×</button>
        </span>
      `).join("");

      el.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => onRemove(btn.getAttribute("data-val")));
      });
    }

    function openImport(){
      initImportOptions();
      state.importChannels = [];
      state.importAccounts = [];
      $("import_file").value = "";
      renderChips("import_channel_chips", state.importChannels, (v)=>{});
      renderChips("import_account_chips", state.importAccounts, (v)=>{});
      // re-render with handlers
      renderChips("import_channel_chips", state.importChannels, removeImportChannel);
      renderChips("import_account_chips", state.importAccounts, removeImportAccount);
      openModal("importMask");
    }

    function addImportChannel(){
      const v = $("import_channel_select").value;
      if(!v) return;
      if(!state.importChannels.includes(v)) state.importChannels.push(v);
      renderChips("import_channel_chips", state.importChannels, removeImportChannel);
    }
    function addImportAccount(){
      const v = $("import_account_select").value;
      if(!v) return;
      if(!state.importAccounts.includes(v)) state.importAccounts.push(v);
      renderChips("import_account_chips", state.importAccounts, removeImportAccount);
    }
    function removeImportChannel(v){
      state.importChannels = state.importChannels.filter(x => x !== v);
      renderChips("import_channel_chips", state.importChannels, removeImportChannel);
    }
    function removeImportAccount(v){
      state.importAccounts = state.importAccounts.filter(x => x !== v);
      renderChips("import_account_chips", state.importAccounts, removeImportAccount);
    }

    function submitImport(){
      // 这是演示页：只校验选择，不解析文件
      const file = $("import_file").files?.[0];
      if(state.importChannels.length === 0){
        alert("请至少选择一个通道编码（可多选）。");
        return;
      }
      if(state.importAccounts.length === 0){
        alert("请至少选择一个账号（可多选）。");
        return;
      }
      if(!file){
        alert("请上传导入文件（xlsx/xls/csv）。");
        return;
      }

      alert(
        "已提交导入（演示）\\n" +
        "通道编码：" + state.importChannels.join(", ") + "\\n" +
        "账号：" + state.importAccounts.join(", ") + "\\n" +
        "文件：" + file.name
      );
      closeModal("importMask");
    }

    // --------------------------
    // Export CSV (demo)
    // --------------------------
    function exportCsv(){
      const rows = state.filtered.length ? state.filtered : state.rows;
      const header = ["序号","通道编码","接入号编码","签名","扩展码","手机号","链接","发送类型","是否启用","备注","任务ID","操作时间"];
      const lines = [header.join(",")];

      rows.forEach((r, i) => {
        const line = [
          i+1, r.channelCode, r.accessNoCode,
          r.signature, r.extCode, r.phone, r.link,
          r.sendType, r.enabled ? "是":"否",
          r.remark || "", r.taskId || "", r.opTime || ""
        ].map(csvEscape).join(",");
        lines.push(line);
      });

      const blob = new Blob(["\ufeff" + lines.join("\n")], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "导出.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
    function csvEscape(v){
      const s = String(v ?? "");
      if(/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
      return s;
    }

    // --------------------------
    // Event wiring
    // --------------------------
    function init(){
      // initial
      applyFilters();

      // filter buttons
      $("btn_search").addEventListener("click", applyFilters);
      $("btn_reset").addEventListener("click", resetFilters);

      // toolbar
      $("btn_import").addEventListener("click", openImport);
      $("btn_export").addEventListener("click", exportCsv);

      // table ops (delegate)
      $("tbody").addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-op]");
        if(!btn) return;
        const tr = e.target.closest("tr");
        const id = tr?.getAttribute("data-id");
        if(!id) return;

        const op = btn.getAttribute("data-op");
        if(op === "edit") openEdit(id);
        if(op === "del") deleteRow(id);
      });

      // close modal
      document.querySelectorAll("[data-close]").forEach(el => {
        el.addEventListener("click", () => closeModal(el.getAttribute("data-close")));
      });
      // click mask close
      ["importMask","editMask"].forEach(mid => {
        $(mid).addEventListener("click", (e) => {
          if(e.target.id === mid) closeModal(mid);
        });
      });

      // edit
      $("edit_save").addEventListener("click", saveEdit);
      $("e_remark").addEventListener("input", () => {
        $("remarkCount").textContent = ($("e_remark").value || "").length;
      });

      // import add/remove
      $("import_add_channel").addEventListener("click", addImportChannel);
      $("import_add_account").addEventListener("click", addImportAccount);
      $("import_submit").addEventListener("click", submitImport);

      // download template (demo)
      $("download_tpl").addEventListener("click", () => {
        alert("示例：这里可跳转到模板下载链接（后端提供真实文件地址）");
      });
    }

    init();
  </script>
</body>
</html>
