<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>测试弹窗问题 - 修复版（按钮触发）</title>
  <style>
    :root{
      --mask-z: 1999;
      --modal-z: 2000;
      --radius: 12px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC",
        "Hiragino Sans GB", "Microsoft YaHei", "Helvetica Neue", Arial, sans-serif;
      background: #f6f7fb;
      color: #111;
    }

    /* ===== 打开弹窗时锁背景滚动 ===== */
    body.modal-open { overflow: hidden; }

    /* ===== 页面演示布局（你可以替换成你的列表页） ===== */
    .page {
      padding: 18px 20px;
      min-height: 100%;
    }
    .topbar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .hint {
      font-size: 13px;
      color: #666;
      margin: 6px 0 14px;
    }
    .layout {
      display: grid;
      grid-template-columns: 240px 1fr 280px;
      gap: 16px;
      align-items: start;
    }
    .card {
      background: #fff;
      border: 1px solid #e9e9ee;
      border-radius: 12px;
      padding: 12px;
      min-height: 520px;
      box-shadow: 0 4px 16px rgba(0,0,0,.03);
    }
    .card h4 {
      margin: 0 0 10px;
      font-size: 14px;
    }
    .placeholder {
      height: 620px;
      border-radius: 12px;
      border: 1px dashed #ddd;
      background: linear-gradient(#fafafa, #f1f1f1);
    }

    @media (max-width: 980px) {
      .layout { grid-template-columns: 1fr; }
    }

    /* ===== 按钮 ===== */
    .btn {
      border: 1px solid #d9d9df;
      background: #fff;
      padding: 8px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      user-select: none;
    }
    .btn:hover { background: #f4f5f8; }
    .btn.primary {
      border-color: #2f7dff;
      background: #2f7dff;
      color: #fff;
    }
    .btn.primary:hover { filter: brightness(.96); }

    /* =========================================================
       弹窗：挂 body、fixed 居中、默认不显示（关键！）
       ========================================================= */

    /* 遮罩：默认隐藏 */
    .modal-mask {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      z-index: var(--mask-z);
      display: none;          /* ✅ 默认不显示 */
      pointer-events: auto;
    }
    .modal-mask.is-open { display: block; } /* ✅ 打开才显示 */

    /* 弹窗容器：默认隐藏 */
    .modal-wrap {
      position: fixed;
      inset: 0;
      z-index: var(--modal-z);
      display: none;          /* ✅ 默认不显示 */
      padding: 24px 16px;
      place-items: center;
    }
    .modal-wrap.is-open { display: grid; }  /* ✅ 打开才显示 */

    .modal {
      width: min(1100px, 100%);
      background: #fff;
      border-radius: var(--radius);
      box-shadow: 0 18px 60px rgba(0,0,0,.25);
      overflow: hidden;
      outline: none;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      border-bottom: 1px solid #eee;
    }
    .modal-title {
      margin: 0;
      font-size: 16px;
      font-weight: 700;
    }
    .modal-close {
      border: none;
      background: transparent;
      font-size: 22px;
      line-height: 1;
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 10px;
    }
    .modal-close:hover { background: #f3f3f3; }

    /* 内容区：限制高度并滚动，避免超出屏幕 */
    .modal-body {
      padding: 16px;
      max-height: calc(100vh - 170px);
      overflow: auto;
    }

    .modal-footer {
      padding: 12px 16px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      background: #fff;
    }

    /* ===== 弹窗内表单示例（你可替换成自己的内容） ===== */
    .section {
      border: 1px solid #efeff4;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
    }
    .section-title {
      font-weight: 700;
      margin: 0 0 10px;
      font-size: 14px;
    }
    label {
      display: block;
      font-size: 13px;
      color: #333;
      margin: 8px 0 6px;
    }
    textarea, input {
      width: 100%;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px;
      font-size: 14px;
      outline: none;
    }
    textarea { min-height: 120px; resize: vertical; }
    input:focus, textarea:focus { border-color: #2f7dff; box-shadow: 0 0 0 3px rgba(47,125,255,.12); }

  </style>
</head>

<body>
  <!-- =================== 页面 =================== -->
  <div class="page">
    <div class="topbar">
      <button class="btn primary" id="openBtn" type="button">打开弹窗</button>
      <button class="btn" id="resetBtn" type="button">重置页面演示</button>
    </div>

    <div class="hint">
      说明：弹窗默认关闭；只有点击“打开弹窗”才会打开；支持 × / 取消 / 点击遮罩 / ESC 关闭。
    </div>

    <div class="layout">
      <div class="card">
        <h4>左侧筛选</h4>
        <div class="placeholder"></div>
      </div>
      <div class="card">
        <h4>中间列表</h4>
        <div class="placeholder"></div>
      </div>
      <div class="card">
        <h4>右侧信息</h4>
        <div class="placeholder"></div>
      </div>
    </div>
  </div>

  <!-- =================== 弹窗（挂在 body 下） =================== -->
  <div class="modal-mask" id="modalMask" aria-hidden="true"></div>

  <div class="modal-wrap" id="modalWrap" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" id="modalPanel" tabindex="-1">
      <div class="modal-header">
        <h3 class="modal-title">测试弹窗</h3>
        <button class="modal-close" id="closeBtn" type="button" aria-label="关闭">×</button>
      </div>

      <div class="modal-body" id="modalBody">
        <h3 style="margin:0 0 12px;">这里放你的弹窗表单内容</h3>

        <div class="section">
          <div class="section-title">联通</div>
          <label>消息内容</label>
          <textarea placeholder="输入内容..."></textarea>
          <label>消息后缀</label>
          <input placeholder="例如：把收请回复R" />
        </div>

        <div class="section">
          <div class="section-title">电信</div>
          <label>消息内容</label>
          <textarea placeholder="输入内容..."></textarea>
          <label>消息后缀</label>
          <input placeholder="例如：把收请回复R" />
        </div>

        <div class="section">
          <div class="section-title">（演示）长内容区域</div>
          <div style="height: 700px; border: 1px dashed #ddd; border-radius: 12px; background:#fafafa; padding: 12px;">
            用来模拟你原页面里很多表单项：这里会在弹窗内部滚动，不会把弹窗顶出屏幕。
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn" id="cancelBtn" type="button">取消</button>
        <button class="btn primary" id="okBtn" type="button">确认</button>
      </div>
    </div>
  </div>

  <script>
    // ✅ 完整弹窗状态机：默认关闭，只能按钮打开，所有入口可关闭
    window.addEventListener('DOMContentLoaded', () => {
      const wrap = document.getElementById('modalWrap');
      const mask = document.getElementById('modalMask');
      const panel = document.getElementById('modalPanel');

      const openBtn = document.getElementById('openBtn');
      const closeBtn = document.getElementById('closeBtn');
      const cancelBtn = document.getElementById('cancelBtn');
      const okBtn = document.getElementById('okBtn');
      const resetBtn = document.getElementById('resetBtn');

      // 基础校验：避免选择器失效导致“关不掉”
      const must = [wrap, mask, panel, openBtn, closeBtn];
      if (must.some(v => !v)) {
        console.error('Modal init failed: missing required elements.');
        return;
      }

      function isOpen() {
        return wrap.classList.contains('is-open');
      }

      function openModal() {
        document.body.classList.add('modal-open');
        wrap.classList.add('is-open');
        mask.classList.add('is-open');
        wrap.setAttribute('aria-hidden', 'false');
        mask.setAttribute('aria-hidden', 'false');

        // 聚焦弹窗，保证 ESC 关闭可靠
        setTimeout(() => panel.focus(), 0);
      }

      function closeModal() {
        document.body.classList.remove('modal-open');
        wrap.classList.remove('is-open');
        mask.classList.remove('is-open');
        wrap.setAttribute('aria-hidden', 'true');
        mask.setAttribute('aria-hidden', 'true');
      }

      // ✅ 兜底：无论你是否误把 is-open 写进 HTML/CSS，这里都强制初始关闭
      closeModal();

      // ✅ 保留你“之前正常逻辑”：只有点击按钮才打开
      openBtn.addEventListener('click', () => {
        if (!isOpen()) openModal();
      });

      // ✅ 关闭：×、取消、遮罩、ESC 都能关
      closeBtn.addEventListener('click', closeModal);
      cancelBtn.addEventListener('click', closeModal);

      okBtn.addEventListener('click', () => {
        // TODO: 你原来的“确认”逻辑可以写在这里（提交表单/请求接口等）
        closeModal();
      });

      // 点击遮罩关闭（注意：绑定在 mask，不会误伤弹窗内部点击）
      mask.addEventListener('click', closeModal);

      // ESC 关闭
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && isOpen()) closeModal();
      });

      // 演示用：重置页面（无业务意义）
      resetBtn.addEventListener('click', () => {
        closeModal();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

      // 防误操作：阻止点击弹窗内部时触发遮罩关闭（当前绑定在 mask 上已不需要，但留着更稳）
      panel.addEventListener('click', (e) => e.stopPropagation());
    });
  </script>
</body>
</html>
