<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>接入号编码签名报备 - 列表</title>
  <style>
    :root{
      --bg:#f5f7fb;
      --card:#fff;
      --text:#1f2937;
      --muted:#6b7280;
      --line:#e5e7eb;
      --primary:#10b981;
      --primary2:#0ea371;
      --blue:#2563eb;
      --danger:#ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius: 12px;
      --radius2: 10px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
      color:var(--text);
      background:var(--bg);
    }
    .page{
      max-width: 1400px;
      margin: 22px auto;
      padding: 0 16px 40px;
    }
    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 6px 4px 14px;
    }
    .brand{ font-weight: 700; font-size: 18px; }
    .main-nav{
      display:flex;
      align-items:center;
      gap: 6px;
      padding: 0 0 14px;
      flex-wrap: wrap;
    }
    .main-nav-btn{
      border:none;
      background: transparent;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 14px;
      cursor:pointer;
      color:#374151;
    }
    .main-nav-btn.active{
      color: var(--blue);
      font-weight: 600;
      border-bottom: 2px solid var(--blue);
      border-radius: 0;
    }
    .panel-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      margin: 0 0 10px;
      padding: 6px 2px;
    }
    .panel-title{ margin:0; font-size: 18px; }
    .main-panel{ margin-top: 6px; }
    .sub-tabs{
      display:flex;
      align-items:center;
      gap: 8px;
      margin: 4px 0 12px;
      flex-wrap: wrap;
    }
    .sub-tab-btn{
      border:1px solid var(--line);
      background:#fff;
      color: var(--text);
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      cursor:pointer;
      transition: all .15s ease;
    }
    .sub-tab-btn:hover{ background:#f9fafb; }
    .sub-tab-btn.active{
      border-color: transparent;
      background: var(--blue);
      color:#fff;
      box-shadow: 0 6px 18px rgba(37,99,235,.18);
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* Filter */
    .filter{
      padding: 18px 18px 12px;
    }
    .filter-grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(220px, 1fr));
      gap: 12px 16px;
      align-items:end;
    }
    .field label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 6px;
    }
    .input, .select, .textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      background:#fff;
      outline:none;
      font-size: 13px;
    }
    .textarea{ min-height: 90px; resize: vertical; }
    .input:focus, .select:focus, .textarea:focus{
      border-color: rgba(16,185,129,.6);
      box-shadow: 0 0 0 3px rgba(16,185,129,.15);
    }
    .hint-inline{
      font-size: 12px;
      color: var(--muted);
      padding: 10px 0 0;
      white-space: nowrap;
    }
    .filter-actions{
      display:flex;
      gap: 10px;
      justify-content:flex-end;
      align-items:center;
    }

    /* Buttons */
    .btn{
      border:1px solid var(--line);
      background:#fff;
      color: var(--text);
      border-radius: 10px;
      padding: 9px 14px;
      font-size: 13px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn:hover{ background:#f9fafb; }
    .btn-primary{
      border-color: transparent;
      background: var(--primary);
      color:#fff;
    }
    .btn-primary:hover{ background: var(--primary2); }
    .btn-danger{
      border-color: rgba(239,68,68,.25);
      color: var(--danger);
      background: rgba(239,68,68,.06);
    }
    .btn-danger:hover{ background: rgba(239,68,68,.10); }
    .btn-blue{
      border-color: transparent;
      background: var(--blue);
      color:#fff;
    }
    .btn-blue:hover{ filter: brightness(.95); }
    .btn-ghost{ background:transparent; }

    /* Toolbar */
    .toolbar{
      display:flex;
      gap: 10px;
      padding: 12px 18px;
      border-top: 1px solid var(--line);
      border-bottom: 1px solid var(--line);
      background:#fff;
      align-items:center;
    }
    .toolbar .spacer{ flex:1; }
    .muted{ color: var(--muted); }
    .stat{
      font-size: 12px;
      color: var(--muted);
    }
    .stat strong{ color:#111827; }

    /* Table */
    .table-wrap{
      overflow:auto;
      background:#fff;
    }
    .table-wrap.narrow table{ min-width: 520px; }
    table{
      width:100%;
      border-collapse: collapse;
      min-width: 1350px;
    }
    thead th{
      background:#fff;
      border-bottom: 1px solid var(--line);
      font-size: 12px;
      color:#374151;
      text-align:left;
      padding: 12px 12px;
      white-space: nowrap;
    }
    tbody td{
      border-bottom: 1px solid var(--line);
      padding: 12px 12px;
      font-size: 13px;
      vertical-align: top;
      white-space: nowrap;
    }
    tbody tr:hover{ background:#f9fafb; }
    a.link{
      color: var(--blue);
      text-decoration:none;
    }
    a.link:hover{ text-decoration:underline; }

    .pill{
      display:inline-flex;
      align-items:center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid var(--line);
      background:#fff;
    }
    .pill.on{ border-color: rgba(16,185,129,.35); background: rgba(16,185,129,.08); color: #0f766e; }
    .pill.off{ border-color: rgba(107,114,128,.35); background: rgba(107,114,128,.08); color: #374151; }

    .ops{
      display:flex;
      gap: 8px;
    }

    /* Modal */
    .modal-mask{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:flex-start;
      justify-content:center;
      padding: 18px;
      z-index: 30;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .modal{
      width: min(920px, 96vw);
      background:#fff;
      border-radius: 12px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(229,231,235,.8);
      overflow:hidden;
      max-height: calc(100vh - 36px);
      display:flex;
      flex-direction: column;
    }
    .modal-header{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--line);
      background:#fff;
    }
    .modal-title{
      font-weight: 600;
    }
    .modal-close{
      border:none;
      background:transparent;
      font-size: 18px;
      cursor:pointer;
      color: var(--muted);
    }
    .modal-body{
      padding: 16px;
      overflow:auto;
      flex: 1 1 auto;
      min-height: 0;
    }
    .modal-footer{
      padding: 14px 16px;
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      border-top:1px solid var(--line);
      background:#fff;
    }
    .form-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(240px, 1fr));
      gap: 12px 16px;
    }
    .full{ grid-column: 1 / -1; }

    /* Chips multi-select */
    .chips{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 8px 10px;
      border:1px solid var(--line);
      border-radius: 10px;
      min-height: 42px;
      background:#fff;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      background:#fff;
    }
    .chip button{
      border:none;
      background:transparent;
      cursor:pointer;
      color: var(--muted);
      font-size: 14px;
      line-height: 1;
    }
    .select-row{
      display:flex;
      gap: 10px;
      align-items:center;
    }
    .select-row .select{ flex:1; }

    /* Import searchable multi-select */
    .label-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin: 0 0 6px;
    }
    .label-row label{ margin:0; }
    .count-pill{
      display:inline-flex;
      align-items:center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: #0f766e;
      background: rgba(16,185,129,.10);
      border: 1px solid rgba(16,185,129,.25);
      white-space: nowrap;
    }
    .search-row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }
    .search-row .input{ flex: 1 1 220px; }
    .result-box{
      margin-top: 10px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background:#fff;
      max-height: 180px;
      overflow:auto;
      padding: 10px;
    }
    .result-empty{
      font-size: 12px;
      color: var(--muted);
      padding: 6px 2px;
    }
    .result-item{
      display:flex;
      align-items:flex-start;
      gap: 10px;
      padding: 6px 4px;
      border-radius: 8px;
      cursor:pointer;
      user-select:none;
    }
    .result-item:hover{ background:#f9fafb; }
    .result-item input{ transform: translateY(2px); }
    .result-text{
      font-size: 13px;
      color: #111827;
      line-height: 1.35;
    }

    .hint{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.6;
    }
    .hint ul{ margin: 6px 0 0 18px; }

    /* Test modal */
    .test-topbar{
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .test-topbar .spacer{ flex:1; }
    .badge{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(37,99,235,.08);
      border: 1px solid rgba(37,99,235,.25);
      color: #1d4ed8;
      font-size: 12px;
    }
    .section{
      border:1px solid var(--line);
      border-radius: 12px;
      padding: 14px;
      background:#fff;
      margin-top: 14px;
    }
    .section-title{
      font-weight: 600;
      margin-bottom: 4px;
    }
    .section-sub{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 12px;
    }
    .carrier-card{
      border:1px solid var(--line);
      border-radius: 12px;
      padding: 14px;
      margin-top: 12px;
      background:#fff;
    }
    .carrier-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .carrier-name{
      font-weight: 600;
    }
    .inline{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .toggle{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      font-size: 13px;
      color:#374151;
      user-select:none;
    }
    .toggle input{ transform: translateY(1px); }
    .small{ width: 240px; }
    .mini{
      padding: 8px 10px;
      border-radius: 10px;
      border:1px solid var(--line);
      font-size: 13px;
      outline:none;
    }
    .phone-add{
      display:flex;
      gap: 8px;
      align-items:center;
      flex-wrap: wrap;
    }
    .phone-add input{ width: 280px; }
    .phones{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .phone-chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background:#f3f4f6;
      border:1px solid var(--line);
      font-size: 12px;
    }
    .phone-chip button{
      border:none;
      background:transparent;
      cursor:pointer;
      color: var(--muted);
      font-size: 14px;
      line-height: 1;
    }
    .placeholder{
      padding: 30px;
      background:#fff;
      border:1px dashed var(--line);
      border-radius: 12px;
      color: var(--muted);
      text-align:center;
    }

    @media (max-width: 1100px){
      .filter-grid{ grid-template-columns: repeat(2, minmax(220px, 1fr)); }
      .form-grid{ grid-template-columns: 1fr; }
      table{ min-width: 1100px; }
    }
    @media (max-width: 720px){
      .filter-grid{ grid-template-columns: 1fr; }
      .toolbar{ flex-wrap: wrap; }
      .toolbar .spacer{ display:none; }
      .panel-head{ flex-direction: column; align-items:flex-start; }
      table{ min-width: 900px; }
    }
  </style>
</head>

<body>
  <div class="page">
    <header class="header">
      <div class="brand">签名管理系统</div>
      <div class="user-info">欢迎，阅信云&nbsp;&nbsp;角色：admin</div>
    </header>

    <nav class="main-nav" aria-label="一级导航">
      <button class="main-nav-btn" data-main="bulk">批量报备</button>
      <button class="main-nav-btn" data-main="template">消息模板规则</button>
      <button class="main-nav-btn" data-main="test">测试配置</button>
      <button class="main-nav-btn" data-main="channel">通道管理</button>
      <button class="main-nav-btn active" data-main="sx">sx报备管理</button>
    </nav>

    <!-- sx 报备管理（默认） -->
    <section class="main-panel" data-main-panel="sx">
      <div class="panel-head">
        <h2 class="panel-title">sx通道报备管理</h2>
        <div class="muted" style="font-size:12px;">支持精准 / 模糊筛选，导入、导出、一键测试</div>
      </div>
      <div id="mappingView" class="card">
        <!-- Filters -->
        <div class="filter">
          <div class="filter-grid">
            <div class="field">
              <label>通道编码（精准）</label>
              <input id="f_channel" class="input" placeholder="请输入通道编码" />
            </div>
            <div class="field">
              <label>签名（模糊）</label>
              <input id="f_signature" class="input" placeholder="请输入签名关键字" />
            </div>
            <div class="field">
              <label>扩展码（精准）</label>
              <input id="f_ext" class="input" placeholder="请输入扩展码" />
            </div>
            <div class="field">
              <label>手机号（精准）</label>
              <input id="f_phone" class="input" placeholder="请输入手机号" />
            </div>

            <div class="field">
              <label>链接（模糊）</label>
              <input id="f_link" class="input" placeholder="请输入链接关键字" />
            </div>
            <div class="field">
              <label>发送类型</label>
              <select id="f_sendType" class="select">
                <option value="">全部</option>
                <option value="行销">行销</option>
                <option value="行业">行业</option>
                <option value="营销">营销</option>
              </select>
            </div>
            <div class="field">
              <label>任务ID（精准）</label>
              <input id="f_taskId" class="input" placeholder="请输入任务ID" />
            </div>

            <div class="field">
              <div class="filter-actions">
                <button class="btn btn-primary" id="btn_search">查询</button>
                <button class="btn" id="btn_reset">重置</button>
              </div>
              <div class="hint-inline">支持：精准/模糊筛选（按你的定义）</div>
            </div>
          </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
          <button class="btn btn-primary" id="btn_import">导入</button>
          <button class="btn" id="btn_export">导出</button>
          <button class="btn btn-blue" id="btn_test">一键测试</button>
          <div class="spacer"></div>
          <div class="stat">数据条数：<strong id="count">0</strong></div>
        </div>

        <!-- Table -->
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width:60px;">序号</th>
                <th>通道编码</th>
                <th>接入号编码</th>
                <th>签名</th>
                <th>扩展码</th>
                <th>手机号</th>
                <th>链接</th>
                <th>发送类型</th>
                <th>是否启用</th>
                <th>备注</th>
                <th>任务ID</th>
                <th>操作时间</th>
                <th style="width:160px;">操作</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- 通道管理（含二级子页） -->
    <section class="main-panel" data-main-panel="channel" style="display:none;">
      <div class="panel-head">
        <h2 class="panel-title">通道管理</h2>
        <div class="muted" style="font-size:12px;">接入号产品映射管理 / sx账号管理 / sx通道管理</div>
      </div>
      <div class="sub-tabs">
        <button class="sub-tab-btn active" data-sub="mapping">接入号产品映射管理</button>
        <button class="sub-tab-btn" data-sub="sxAccount">sx账号管理</button>
        <button class="sub-tab-btn" data-sub="sxChannel">sx通道管理</button>
      </div>

      <div class="sub-panel" data-sub-panel="mapping">
        <div id="channelMappingView" class="card">
          <div class="card-head" style="align-items:flex-start;">
            <div>
              <div class="card-title">通道管理</div>
              <div class="muted" style="font-size:12px; margin-top:2px;">管理接入号与产品编码的映射关系</div>
            </div>
            <button class="btn btn-blue" id="cm_add">新增映射</button>
          </div>
          <div class="card-body">
            <div class="search-row" style="margin-bottom:12px;">
              <input id="cm_kw" class="input" placeholder="搜索接入号编码或产品编码" />
              <button class="btn btn-blue" id="cm_search">搜索</button>
              <button class="btn" id="cm_reset">重置</button>
            </div>
            <div class="table-wrap" style="background:transparent;">
              <table>
                <thead>
                  <tr>
                    <th style="width:120px;">接入号编码</th>
                    <th style="width:120px;">产品编码</th>
                    <th>创建人</th>
                    <th>创建时间</th>
                    <th>修改人</th>
                    <th>修改时间</th>
                    <th style="width:120px;">操作</th>
                  </tr>
                </thead>
                <tbody id="cm_tbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="sub-panel" data-sub-panel="sxAccount" style="display:none;">
        <div class="card">
          <div class="card-head">
            <div>
              <div class="card-title">sx账号管理</div>
              <div class="muted" style="font-size:12px; margin-top:2px;">维护账号编码与账号名称，支持新增/编辑/删除。</div>
            </div>
            <button class="btn btn-primary" id="btn_add_account">新增账号</button>
          </div>
          <div class="table-wrap narrow">
            <table>
              <thead>
                <tr>
                  <th style="width:60px;">序号</th>
                  <th>账号</th>
                  <th>账号名称</th>
                  <th style="width:160px;">操作</th>
                </tr>
              </thead>
              <tbody id="sx_account_tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="sub-panel" data-sub-panel="sxChannel" style="display:none;">
        <div class="card">
          <div class="card-head">
            <div>
              <div class="card-title">sx通道管理</div>
              <div class="muted" style="font-size:12px; margin-top:2px;">维护通道编码，支持新增/编辑/删除。</div>
            </div>
            <button class="btn btn-primary" id="btn_add_channel">新增通道</button>
          </div>
          <div class="table-wrap narrow">
            <table>
              <thead>
                <tr>
                  <th style="width:60px;">序号</th>
                  <th>通道编码</th>
                  <th style="width:160px;">操作</th>
                </tr>
              </thead>
              <tbody id="sx_channel_tbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- 其他一级导航占位 -->
    <section class="main-panel" data-main-panel="bulk" style="display:none;">
      <div class="placeholder">批量报备（待接入）</div>
    </section>
    <section class="main-panel" data-main-panel="template" style="display:none;">
      <div class="placeholder">消息模板规则（待接入）</div>
    </section>
    <section class="main-panel" data-main-panel="test" style="display:none;">
      <div class="placeholder">测试配置（待接入）</div>
    </section>

  </div>

  <!-- Import Modal -->
  <div class="modal-mask" id="importMask" aria-hidden="true">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">导入</div>
        <button class="modal-close" data-close="importMask">✕</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="field">
            <div class="label-row">
              <label for="import_channel_kw">选择通道编码（多选）</label>
              <span class="count-pill" id="import_channel_count">已选 0</span>
            </div>
            <div class="search-row">
              <input id="import_channel_kw" class="input" placeholder="输入通道编码模糊查询（留空查询全部）" />
              <button class="btn" id="import_channel_search">查询</button>
              <button class="btn" id="import_channel_selectall">全选本次结果</button>
              <button class="btn btn-danger" id="import_channel_clear">清空已选</button>
            </div>
            <div class="result-box" id="import_channel_results"></div>
            <div class="chips" id="import_channel_chips"></div>
          </div>

          <div class="field">
            <div class="label-row">
              <label for="import_account_kw">选择账号（多选）</label>
              <span class="count-pill" id="import_account_count">已选 0</span>
            </div>
            <div class="search-row">
              <input id="import_account_kw" class="input" placeholder="输入账号名称模糊查询（留空查询全部）" />
              <button class="btn" id="import_account_search">查询</button>
              <button class="btn" id="import_account_selectall">全选本次结果</button>
              <button class="btn btn-danger" id="import_account_clear">清空已选</button>
            </div>
            <div class="result-box" id="import_account_results"></div>
            <div class="chips" id="import_account_chips"></div>
          </div>

          <div class="field full">
            <label>导入文件</label>
            <input id="import_file" type="file" class="input" accept=".xlsx,.xls,.csv" />
            <div class="hint">
              点击下载：<a class="link" href="javascript:void(0)" id="download_tpl">接入号编码报备范例.xlsx</a>
              <ul>
                <li>请上传 xlsx/xls/csv 格式（演示页面不解析，仅做交互展示）</li>
                <li>excel 单元格格式请勿使用“常规”或“文本”以外格式（提示文案示意）</li>
                <li>单次导入建议不超过 10000 条（提示文案示意）</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" data-close="importMask">取消</button>
        <button class="btn btn-primary" id="import_submit">提交</button>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal-mask" id="editMask" aria-hidden="true">
    <div class="modal" style="width:min(760px, 96vw);">
      <div class="modal-header">
        <div class="modal-title">编辑</div>
        <button class="modal-close" data-close="editMask">✕</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="field">
            <label>接入号编码（不可编辑）</label>
            <input id="e_accessNo" class="input" disabled />
          </div>
          <div class="field">
            <label>签名（不可编辑）</label>
            <input id="e_signature" class="input" disabled />
          </div>
          <div class="field">
            <label>扩展码（不可编辑）</label>
            <input id="e_ext" class="input" disabled />
          </div>

          <div class="field">
            <label>发送类型（可编辑）</label>
            <select id="e_sendType" class="select">
              <option value="行销">行销</option>
              <option value="行业">行业</option>
              <option value="营销">营销</option>
            </select>
          </div>

          <div class="field">
            <label>是否启用（可编辑）</label>
            <select id="e_enabled" class="select">
              <option value="true">是</option>
              <option value="false">否</option>
            </select>
          </div>

          <div class="field full">
            <label>备注（可编辑）</label>
            <textarea id="e_remark" class="textarea" placeholder="请输入备注（可选）" maxlength="200"></textarea>
            <div class="muted" style="font-size:12px; margin-top:6px; text-align:right;">
              <span id="remarkCount">0</span>/200
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" data-close="editMask">取消</button>
        <button class="btn btn-primary" id="edit_save">确定</button>
      </div>
    </div>
  </div>

  <!-- Test Modal -->
  <div class="modal-mask" id="testMask" aria-hidden="true">
    <div class="modal" style="width:min(1100px, 96vw);">
      <div class="modal-header">
        <div class="test-topbar" style="width:100%;">
          <div>
            <div class="modal-title">测试</div>
            <div class="muted" style="font-size:12px; margin-top:4px;">选择测试配置并提交批量测试（演示）</div>
          </div>
          <div class="spacer"></div>
          <span class="badge" id="testCountBadge">当前测试 0 条</span>
          <button class="btn" id="btn_collapse_test">收起测试</button>
          <button class="btn btn-blue" id="btn_submit_test">提交测试</button>
          <button class="modal-close" data-close="testMask" title="关闭">✕</button>
        </div>
      </div>

      <div class="modal-body">
        <div class="section">
          <div class="section-title">测试配置</div>
          <div class="section-sub">选择测试配置后可编辑每个运营商的测试参数</div>

          <div class="form-grid">
            <div class="field">
              <label>测试配置</label>
              <select id="test_profile" class="select">
                <option value="通用测试">通用测试</option>
                <option value="短链测试">短链测试</option>
                <option value="高频测试">高频测试</option>
              </select>
            </div>
            <div class="field">
              <label>通用测试</label>
              <div class="muted" style="padding:10px 0 0;">无（演示占位）</div>
            </div>
          </div>
        </div>

        <!-- Carriers -->
        <div class="carrier-card" data-carrier="移动">
          <div class="carrier-head">
            <div>
              <div class="carrier-name">移动</div>
              <div class="muted" style="font-size:12px;">运营商编码：1</div>
            </div>
            <div class="inline">
              <label class="toggle"><input type="checkbox" class="shortlinkToggle" /> 启用短链</label>
              <input class="mini shortlinkTitle small" placeholder="短链标题" />
            </div>
          </div>

          <div class="form-grid">
            <div class="field full">
              <label>消息内容</label>
              <textarea class="textarea msgContent" placeholder="请输入消息内容"></textarea>
            </div>
            <div class="field full">
              <label>消息后缀</label>
              <input class="input msgSuffix" placeholder="例如：拒收请回复R" />
            </div>
          </div>

          <div class="field" style="margin-top:12px;">
            <label>测试电话号码</label>
            <div class="phone-add">
              <input class="input phoneInput" placeholder="输入号码，逗号/空格分隔" />
              <button class="btn addPhoneBtn">添加</button>
            </div>
            <div class="phones phoneChips"></div>
          </div>
        </div>

        <div class="carrier-card" data-carrier="联通">
          <div class="carrier-head">
            <div>
              <div class="carrier-name">联通</div>
              <div class="muted" style="font-size:12px;">运营商编码：2</div>
            </div>
            <div class="inline">
              <label class="toggle"><input type="checkbox" class="shortlinkToggle" /> 启用短链</label>
              <input class="mini shortlinkTitle small" placeholder="短链标题" />
            </div>
          </div>

          <div class="form-grid">
            <div class="field full">
              <label>消息内容</label>
              <textarea class="textarea msgContent" placeholder="请输入消息内容"></textarea>
            </div>
            <div class="field full">
              <label>消息后缀</label>
              <input class="input msgSuffix" placeholder="例如：拒收请回复R" />
            </div>
          </div>

          <div class="field" style="margin-top:12px;">
            <label>测试电话号码</label>
            <div class="phone-add">
              <input class="input phoneInput" placeholder="输入号码，逗号/空格分隔" />
              <button class="btn addPhoneBtn">添加</button>
            </div>
            <div class="phones phoneChips"></div>
          </div>
        </div>

        <div class="carrier-card" data-carrier="电信">
          <div class="carrier-head">
            <div>
              <div class="carrier-name">电信</div>
              <div class="muted" style="font-size:12px;">运营商编码：3</div>
            </div>
            <div class="inline">
              <label class="toggle"><input type="checkbox" class="shortlinkToggle" /> 启用短链</label>
              <input class="mini shortlinkTitle small" placeholder="短链标题" />
            </div>
          </div>

          <div class="form-grid">
            <div class="field full">
              <label>消息内容</label>
              <textarea class="textarea msgContent" placeholder="请输入消息内容"></textarea>
            </div>
            <div class="field full">
              <label>消息后缀</label>
              <input class="input msgSuffix" placeholder="例如：拒收请回复R" />
            </div>
          </div>

          <div class="field" style="margin-top:12px;">
            <label>测试电话号码</label>
            <div class="phone-add">
              <input class="input phoneInput" placeholder="输入号码，逗号/空格分隔" />
              <button class="btn addPhoneBtn">添加</button>
            </div>
            <div class="phones phoneChips"></div>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn" data-close="testMask">关闭</button>
        <button class="btn btn-blue" id="btn_submit_test_2">提交测试</button>
      </div>
    </div>
  </div>

  <!-- Account Modal -->
  <div class="modal-mask" id="modalAccount" aria-hidden="true">
    <div class="modal" style="width:min(520px, 96vw);">
      <div class="modal-header">
        <div class="modal-title" id="modal_account_title">新增账号</div>
        <button class="modal-close" data-close="modalAccount">✕</button>
      </div>
      <div class="modal-body">
        <div class="form-grid" style="grid-template-columns: 1fr;">
          <div class="field">
            <label>账号</label>
            <input id="acc_id" class="input" placeholder="请输入账号编码" />
          </div>
          <div class="field">
            <label>账号名称</label>
            <input id="acc_name" class="input" placeholder="请输入账号名称" />
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" data-close="modalAccount">取消</button>
        <button class="btn btn-primary" id="acc_save">保存</button>
      </div>
    </div>
  </div>

  <!-- Channel Modal -->
  <div class="modal-mask" id="modalChannel" aria-hidden="true">
    <div class="modal" style="width:min(520px, 96vw);">
      <div class="modal-header">
        <div class="modal-title" id="modal_channel_title">新增通道</div>
        <button class="modal-close" data-close="modalChannel">✕</button>
      </div>
      <div class="modal-body">
        <div class="form-grid" style="grid-template-columns: 1fr;">
          <div class="field">
            <label>通道编码</label>
            <input id="channel_code" class="input" placeholder="请输入通道编码" />
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" data-close="modalChannel">取消</button>
        <button class="btn btn-primary" id="channel_save">保存</button>
      </div>
    </div>
  </div>

  <script>
    // --------------------------
    // Mock data
    // --------------------------
    const DATA = [
      {
        id: crypto.randomUUID(),
        channelCode: "YZ",
        accessNoCode: "1QG106828164",
        signature: "【鹿城区南浦李金燕服装店】",
        extCode: "8000102068",
        phone: "13800001111",
        link: "https://example.com/a?src=yz",
        sendType: "行销",
        enabled: true,
        remark: "首批导入",
        taskId: "T-20251230-001",
        opTime: "2025-12-30 10:18:22",
      },
      {
        id: crypto.randomUUID(),
        channelCode: "YZ",
        accessNoCode: "1QG106848241",
        signature: "【鹿城区南浦李金燕服装店】",
        extCode: "8000102068",
        phone: "13800002222",
        link: "https://example.com/b",
        sendType: "行业",
        enabled: true,
        remark: "-",
        taskId: "T-20251230-002",
        opTime: "2025-12-30 09:11:02",
      },
      {
        id: crypto.randomUUID(),
        channelCode: "DX",
        accessNoCode: "AC-99887766",
        signature: "【XX有限公司】",
        extCode: "9000100001",
        phone: "13912345678",
        link: "https://landing.example.com/promo",
        sendType: "营销",
        enabled: true,
        remark: "渠道DX测试",
        taskId: "T-20251229-009",
        opTime: "2025-12-29 16:44:01",
      },
      {
        id: crypto.randomUUID(),
        channelCode: "LT",
        accessNoCode: "LT-11223344",
        signature: "【某门店】",
        extCode: "7000123456",
        phone: "13711112222",
        link: "https://example.com/store",
        sendType: "行销",
        enabled: false,
        remark: "长期",
        taskId: "T-20251228-003",
        opTime: "2025-12-28 09:12:45",
      },
    ];

    let state = {
      rows: [...DATA],
      filtered: [],
      editingId: null,
      importChannels: [],
      importAccounts: [],
      importSources: { channels: [], accounts: [] },
      importChannelResults: [],
      importAccountResults: [],
      // test state
      test: {
        count: 0,
        carriers: {
          "移动": { shortLink:false, shortTitle:"", content:"测试", suffix:"拒收请回复R", phones:["15735106554","18340756179","15110302313","15010298912"] },
          "联通": { shortLink:false, shortTitle:"", content:"测试", suffix:"拒收请回复R", phones:["18634348313"] },
          "电信": { shortLink:false, shortTitle:"", content:"测试", suffix:"拒收请回复R", phones:[] },
        }
      }
    };

    const SUB_STORAGE_KEYS = {
      accounts: "sx_accounts_table_v1",
      channels: "sx_channels_table_v1",
    };
    let currentMain = "sx"; // 默认 sx报备管理
    let currentSub = "mapping"; // 通道管理下的子页
    const sxTables = {
      accounts: [],
      channels: [],
    };
    const channelMapState = {
      rows: [
        { id: crypto.randomUUID(), accessNo:"1QG10682223", productCode:"1999751", creator:"王鑫", createTime:"2026-01-06 10:09:16", modifier:"王鑫", modifyTime:"2026-01-06 10:09:16" },
        { id: crypto.randomUUID(), accessNo:"1QG106804772", productCode:"1999778", creator:"-", createTime:"-", modifier:"-", modifyTime:"-" },
        { id: crypto.randomUUID(), accessNo:"1QG106825753", productCode:"1999487", creator:"-", createTime:"-", modifier:"-", modifyTime:"-" },
        { id: crypto.randomUUID(), accessNo:"1QG106939954", productCode:"1999757", creator:"-", createTime:"-", modifier:"-", modifyTime:"-" },
        { id: crypto.randomUUID(), accessNo:"1QG106913531", productCode:"1999786", creator:"-", createTime:"-", modifier:"-", modifyTime:"-" },
        { id: crypto.randomUUID(), accessNo:"1QG106804155", productCode:"1999754", creator:"-", createTime:"-", modifier:"-", modifyTime:"-" },
        { id: crypto.randomUUID(), accessNo:"1QG106836271", productCode:"1999756", creator:"-", createTime:"-", modifier:"-", modifyTime:"-" },
        { id: crypto.randomUUID(), accessNo:"1QG106856544", productCode:"1999755", creator:"-", createTime:"-", modifier:"-", modifyTime:"-" },
        { id: crypto.randomUUID(), accessNo:"1QG10685504", productCode:"1999673", creator:"-", createTime:"-", modifier:"-", modifyTime:"-" },
        { id: crypto.randomUUID(), accessNo:"1QG10680674", productCode:"1999634", creator:"-", createTime:"-", modifier:"-", modifyTime:"-" },
        { id: crypto.randomUUID(), accessNo:"1QG106804121", productCode:"1999781", creator:"-", createTime:"-", modifier:"-", modifyTime:"-" },
        { id: crypto.randomUUID(), accessNo:"1QG106929055", productCode:"1999791", creator:"-", createTime:"-", modifier:"-", modifyTime:"-" },
      ],
      filtered: [],
      keyword: "",
    };

    // --------------------------
    // Helpers
    // --------------------------
    const $ = (id) => document.getElementById(id);

    function contains(hay, needle){
      return String(hay ?? "").toLowerCase().includes(String(needle ?? "").toLowerCase());
    }
    function equals(a,b){
      return String(a ?? "") === String(b ?? "");
    }
    function fmtEnabled(v){
      return v ? `<span class="pill on">启用</span>` : `<span class="pill off">停用</span>`;
    }
    function shorten(s, n){
      s = String(s || "");
      if(s.length <= n) return s;
      return s.slice(0, n-1) + "…";
    }
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(str){ return escapeHtml(str); }
    function writeJson(key, value){
      localStorage.setItem(key, JSON.stringify(value));
    }

    // --------------------------
    // Render table
    // --------------------------
    function switchMain(main){
      const mains = ["bulk","template","test","channel","sx"];
      if(!mains.includes(main)) main = "sx";
      currentMain = main;
      mains.forEach(m => {
        const panel = document.querySelector(`[data-main-panel='${m}']`);
        const btn = document.querySelector(`.main-nav-btn[data-main='${m}']`);
        if(panel) panel.style.display = m === main ? "block" : "none";
        if(btn){
          btn.classList.toggle("active", m === main);
          btn.setAttribute("aria-pressed", m === main ? "true" : "false");
        }
      });
      if(main === "channel"){
        switchSub(currentSub);
      }
    }

    function switchSub(sub){
      const subs = ["mapping","sxAccount","sxChannel"];
      if(!subs.includes(sub)) sub = "mapping";
      currentSub = sub;
      subs.forEach(s => {
        const panel = document.querySelector(`[data-sub-panel='${s}']`);
        const btn = document.querySelector(`.sub-tab-btn[data-sub='${s}']`);
        if(panel) panel.style.display = s === sub ? "block" : "none";
        if(btn){
          btn.classList.toggle("active", s === sub);
          btn.setAttribute("aria-pressed", s === sub ? "true" : "false");
        }
      });
    }

    function loadSxTables(){
      const acc = readJson(SUB_STORAGE_KEYS.accounts, null);
      sxTables.accounts = Array.isArray(acc) && acc.length ? acc : [
        { id:"10001", name:"示例账号A" },
        { id:"20001", name:"示例账号B" },
      ];
      const ch = readJson(SUB_STORAGE_KEYS.channels, null);
      sxTables.channels = Array.isArray(ch) && ch.length ? ch : [
        { code:"DX" },
        { code:"LT" },
        { code:"YD" },
      ];
    }

    function renderChannelMap(){
      const rows = channelMapState.filtered.length ? channelMapState.filtered : channelMapState.rows;
      const tbody = $("cm_tbody");
      if(!rows.length){
        tbody.innerHTML = `<tr><td colspan="7" class="muted" style="padding:14px 12px;">暂无数据</td></tr>`;
        return;
      }
      tbody.innerHTML = rows.map(r => `
        <tr data-id="${escapeAttr(r.id)}">
          <td>${escapeHtml(r.accessNo)}</td>
          <td>${escapeHtml(r.productCode)}</td>
          <td>${escapeHtml(r.creator)}</td>
          <td>${escapeHtml(r.createTime)}</td>
          <td>${escapeHtml(r.modifier)}</td>
          <td>${escapeHtml(r.modifyTime)}</td>
          <td><button class="btn btn-blue" data-op="edit">编辑</button></td>
        </tr>
      `).join("");
    }

    function filterChannelMap(){
      const kw = channelMapState.keyword.trim();
      if(!kw){
        channelMapState.filtered = [...channelMapState.rows];
      }else{
        channelMapState.filtered = channelMapState.rows.filter(r =>
          contains(r.accessNo, kw) || contains(r.productCode, kw)
        );
      }
      renderChannelMap();
    }

    function renderAccountTable(){
      const tbody = $("sx_account_tbody");
      if(!sxTables.accounts.length){
        tbody.innerHTML = `<tr><td colspan="4" class="muted" style="padding:14px 12px;">暂无数据</td></tr>`;
        return;
      }
      tbody.innerHTML = sxTables.accounts.map((r, idx) => `
        <tr data-id="${escapeAttr(r.id)}">
          <td>${idx + 1}</td>
          <td>${escapeHtml(r.id)}</td>
          <td>${escapeHtml(r.name)}</td>
          <td>
            <div class="ops">
              <button class="btn btn-ghost" data-op="edit">编辑</button>
              <button class="btn btn-danger" data-op="del">删除</button>
            </div>
          </td>
        </tr>
      `).join("");
    }

    function renderChannelTable(){
      const tbody = $("sx_channel_tbody");
      if(!sxTables.channels.length){
        tbody.innerHTML = `<tr><td colspan="3" class="muted" style="padding:14px 12px;">暂无数据</td></tr>`;
        return;
      }
      tbody.innerHTML = sxTables.channels.map((r, idx) => `
        <tr data-code="${escapeAttr(r.code)}">
          <td>${idx + 1}</td>
          <td>${escapeHtml(r.code)}</td>
          <td>
            <div class="ops">
              <button class="btn btn-ghost" data-op="edit">编辑</button>
              <button class="btn btn-danger" data-op="del">删除</button>
            </div>
          </td>
        </tr>
      `).join("");
    }

    function openAccountModal(mode, id){
      const title = mode === "edit" ? "编辑账号" : "新增账号";
      $("modal_account_title").textContent = title;
      $("modalAccount").setAttribute("data-mode", mode);
      $("modalAccount").setAttribute("data-id", id || "");

      $("acc_id").value = "";
      $("acc_name").value = "";

      if(mode === "edit"){
        const item = sxTables.accounts.find(x => x.id === id);
        if(!item) return;
        $("acc_id").value = item.id;
        $("acc_name").value = item.name;
      }

      openModal("modalAccount");
    }

    function saveAccount(){
      const mode = $("modalAccount").getAttribute("data-mode") || "create";
      const editingId = $("modalAccount").getAttribute("data-id") || "";
      const id = $("acc_id").value.trim();
      const name = $("acc_name").value.trim();
      if(!id || !name){
        alert("请填写账号和账号名称。");
        return;
      }
      const dup = sxTables.accounts.some(x => x.id === id && id !== editingId);
      if(dup){
        alert("账号已存在，请勿重复添加。");
        return;
      }
      if(mode === "edit"){
        const idx = sxTables.accounts.findIndex(x => x.id === editingId);
        if(idx >= 0){
          sxTables.accounts[idx] = { id, name };
        }
      }else{
        sxTables.accounts.push({ id, name });
      }
      writeJson(SUB_STORAGE_KEYS.accounts, sxTables.accounts);
      renderAccountTable();
      closeModal("modalAccount");
    }

    function deleteAccount(id){
      const item = sxTables.accounts.find(x => x.id === id);
      if(!item) return;
      const ok = confirm(`确认删除账号？\n账号：${item.id}\n账号名称：${item.name || "-"}`);
      if(!ok) return;
      sxTables.accounts = sxTables.accounts.filter(x => x.id !== id);
      writeJson(SUB_STORAGE_KEYS.accounts, sxTables.accounts);
      renderAccountTable();
    }

    function openChannelModal(mode, code){
      const title = mode === "edit" ? "编辑通道" : "新增通道";
      $("modal_channel_title").textContent = title;
      $("modalChannel").setAttribute("data-mode", mode);
      $("modalChannel").setAttribute("data-code", code || "");

      $("channel_code").value = "";
      if(mode === "edit"){
        const item = sxTables.channels.find(x => x.code === code);
        if(!item) return;
        $("channel_code").value = item.code;
      }

      openModal("modalChannel");
    }

    function saveChannel(){
      const mode = $("modalChannel").getAttribute("data-mode") || "create";
      const editingCode = $("modalChannel").getAttribute("data-code") || "";
      const code = $("channel_code").value.trim();
      if(!code){
        alert("请输入通道编码。");
        return;
      }
      const dup = sxTables.channels.some(x => x.code === code && code !== editingCode);
      if(dup){
        alert("通道编码已存在，请勿重复添加。");
        return;
      }
      if(mode === "edit"){
        const idx = sxTables.channels.findIndex(x => x.code === editingCode);
        if(idx >= 0){
          sxTables.channels[idx] = { code };
        }
      }else{
        sxTables.channels.push({ code });
      }
      writeJson(SUB_STORAGE_KEYS.channels, sxTables.channels);
      renderChannelTable();
      closeModal("modalChannel");
    }

    function deleteChannel(code){
      const item = sxTables.channels.find(x => x.code === code);
      if(!item) return;
      const ok = confirm(`确认删除通道编码？\n通道编码：${item.code}`);
      if(!ok) return;
      sxTables.channels = sxTables.channels.filter(x => x.code !== code);
      writeJson(SUB_STORAGE_KEYS.channels, sxTables.channels);
      renderChannelTable();
    }

    function renderTable(rows){
      const tbody = $("tbody");
      tbody.innerHTML = rows.map((r, idx) => `
        <tr data-id="${r.id}">
          <td>${idx + 1}</td>
          <td>${escapeHtml(r.channelCode)}</td>
          <td>${escapeHtml(r.accessNoCode)}</td>
          <td title="${escapeHtml(r.signature)}">${escapeHtml(r.signature)}</td>
          <td>${escapeHtml(r.extCode)}</td>
          <td>${escapeHtml(r.phone)}</td>
          <td title="${escapeHtml(r.link)}">
            <a class="link" href="${escapeAttr(r.link)}" target="_blank" rel="noreferrer">${escapeHtml(shorten(r.link, 28))}</a>
          </td>
          <td>${escapeHtml(r.sendType)}</td>
          <td>${fmtEnabled(r.enabled)}</td>
          <td title="${escapeHtml(r.remark || "-")}">${escapeHtml(r.remark || "-")}</td>
          <td>${escapeHtml(r.taskId || "-")}</td>
          <td>${escapeHtml(r.opTime || "-")}</td>
          <td>
            <div class="ops">
              <button class="btn btn-ghost" data-op="edit">编辑</button>
              <button class="btn btn-danger" data-op="del">删除</button>
            </div>
          </td>
        </tr>
      `).join("");
      $("count").textContent = rows.length;
    }

    // --------------------------
    // Filtering logic
    // --------------------------
    function applyFilters(){
      const fChannel = $("f_channel").value.trim();
      const fSign = $("f_signature").value.trim();
      const fExt = $("f_ext").value.trim();
      const fPhone = $("f_phone").value.trim();
      const fLink = $("f_link").value.trim();
      const fSend = $("f_sendType").value.trim();
      const fTask = $("f_taskId").value.trim();

      const rows = state.rows.filter(r => {
        if (fChannel && !equals(r.channelCode, fChannel)) return false;  // 通道编码精准
        if (fExt && !equals(r.extCode, fExt)) return false;              // 扩展码精准
        if (fPhone && !equals(r.phone, fPhone)) return false;            // 手机号精准
        if (fSend && !equals(r.sendType, fSend)) return false;           // 发送类型下拉
        if (fTask && !equals(r.taskId, fTask)) return false;             // 任务ID精准
        if (fSign && !contains(r.signature, fSign)) return false;        // 签名模糊
        if (fLink && !contains(r.link, fLink)) return false;             // 链接模糊
        return true;
      });

      state.filtered = rows;
      renderTable(rows);
    }

    function resetFilters(){
      $("f_channel").value = "";
      $("f_signature").value = "";
      $("f_ext").value = "";
      $("f_phone").value = "";
      $("f_link").value = "";
      $("f_sendType").value = "";
      $("f_taskId").value = "";
      applyFilters();
    }

    // --------------------------
    // Modals
    // --------------------------
    function openModal(maskId){
      const el = $(maskId);
      el.style.display = "flex";
      el.setAttribute("aria-hidden","false");
    }
    function closeModal(maskId){
      const el = $(maskId);
      el.style.display = "none";
      el.setAttribute("aria-hidden","true");
    }

    // --------------------------
    // Edit flow
    // --------------------------
    function openEdit(id){
      const row = state.rows.find(x => x.id === id);
      if(!row) return;

      state.editingId = id;
      $("e_accessNo").value = row.accessNoCode;
      $("e_signature").value = row.signature;
      $("e_ext").value = row.extCode;
      $("e_sendType").value = row.sendType;
      $("e_enabled").value = String(row.enabled);
      $("e_remark").value = row.remark && row.remark !== "-" ? row.remark : "";
      $("remarkCount").textContent = ($("e_remark").value || "").length;

      openModal("editMask");
    }

    function saveEdit(){
      const id = state.editingId;
      const idx = state.rows.findIndex(x => x.id === id);
      if(idx < 0) return;

      state.rows[idx].sendType = $("e_sendType").value;
      state.rows[idx].enabled = $("e_enabled").value === "true";
      state.rows[idx].remark = $("e_remark").value.trim() || "-";
      state.rows[idx].opTime = new Date().toISOString().slice(0,19).replace("T"," ");

      closeModal("editMask");
      applyFilters();
    }

    // --------------------------
    // Delete flow
    // --------------------------
    function deleteRow(id){
      const row = state.rows.find(x => x.id === id);
      if(!row) return;

      const ok = confirm(`确认删除？\n接入号编码：${row.accessNoCode}\n签名：${row.signature}`);
      if(!ok) return;

      state.rows = state.rows.filter(x => x.id !== id);
      applyFilters();
    }

    // --------------------------
    // Import flow (demo)
    // --------------------------
    const STORAGE_KEYS = {
      allowedChannels: "sx_allowed_channels_v1",
      allowedAccounts: "sx_allowed_accounts_v1",
    };

    function readJson(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return fallback;
        const v = JSON.parse(raw);
        return v ?? fallback;
      }catch{
        return fallback;
      }
    }

    function buildImportSources(){
      const channelNameMap = {
        "YZ": "扬州通道",
        "DX": "电信通道",
        "LT": "联通通道",
        "YD": "移动通道",
      };
      const fromRows = Array.from(new Set(state.rows.map(r => r.channelCode))).sort();
      const baseChannels = fromRows.map(code => ({
        id: code,
        code,
        name: channelNameMap[code] || `${code}通道`,
      }));
      if(!baseChannels.some(x => x.id === "YD")){
        baseChannels.push({ id:"YD", code:"YD", name:"移动通道" });
      }

      const accounts = [
        { id:"10001", name:"账号A" },
        { id:"10002", name:"账号B" },
        { id:"10003", name:"账号C" },
        { id:"20001", name:"商信-主账号" },
        { id:"20002", name:"商信-行业线账号" },
      ];

      const allowedChannels = readJson(STORAGE_KEYS.allowedChannels, null);
      const allowedAccounts = readJson(STORAGE_KEYS.allowedAccounts, null);

      state.importSources = {
        channels: (Array.isArray(allowedChannels) && allowedChannels.length)
          ? baseChannels.filter(x => allowedChannels.includes(x.id)).sort((a,b) => a.code.localeCompare(b.code))
          : baseChannels.sort((a,b) => a.code.localeCompare(b.code)),
        accounts: (Array.isArray(allowedAccounts) && allowedAccounts.length)
          ? accounts.filter(x => allowedAccounts.includes(x.id))
          : accounts,
      };
    }

    function renderChips(containerId, items, onRemove){
      const el = $(containerId);
      if(items.length === 0){
        el.innerHTML = `<span class="muted" style="font-size:12px;">未选择</span>`;
        return;
      }
      el.innerHTML = items.map(it => `
        <span class="chip">
          ${escapeHtml(it.label)}
          <button title="移除" data-val="${escapeAttr(it.key)}">×</button>
        </span>
      `).join("");
      el.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => onRemove(btn.getAttribute("data-val")));
      });
    }

    function uniquePush(arr, v){
      if(!arr.includes(v)) arr.push(v);
    }
    function removeFromArr(arr, v){
      return arr.filter(x => x !== v);
    }
    function getAccountLabel(id){
      const a = state.importSources.accounts.find(x => x.id === id);
      if(!a) return id;
      return `${a.id} ${a.name}`;
    }

    function renderImportCounts(){
      $("import_channel_count").textContent = `已选 ${state.importChannels.length}`;
      $("import_account_count").textContent = `已选 ${state.importAccounts.length}`;
    }
    function renderImportChips(){
      renderChips(
        "import_channel_chips",
        state.importChannels.map(id => ({ key:id, label:id })),
        removeImportChannel
      );
      renderChips(
        "import_account_chips",
        state.importAccounts.map(id => ({ key:id, label:getAccountLabel(id) })),
        removeImportAccount
      );
      renderImportCounts();
    }

    function renderImportResults(type){
      const isChannel = type === "channel";
      const kw = (isChannel ? $("import_channel_kw") : $("import_account_kw")).value.trim();
      const results = isChannel ? state.importChannelResults : state.importAccountResults;
      const selected = isChannel ? state.importChannels : state.importAccounts;
      const box = isChannel ? $("import_channel_results") : $("import_account_results");

      if(results.length === 0){
        box.innerHTML = `<div class="result-empty">${kw ? "无匹配结果" : "请输入关键字并点击查询（留空查询全部）"}</div>`;
        return;
      }

      box.innerHTML = results.map(item => {
        const id = item.id;
        const checked = selected.includes(id) ? "checked" : "";
        const label = isChannel ? item.code : `${item.id} ${item.name}`;
        return `
          <label class="result-item">
            <input type="checkbox" data-id="${escapeAttr(id)}" ${checked} />
            <span class="result-text">${escapeHtml(label)}</span>
          </label>
        `;
      }).join("");

      box.querySelectorAll("input[type='checkbox']").forEach(input => {
        input.addEventListener("change", () => {
          const id = input.getAttribute("data-id");
          const checked = input.checked;
          if(isChannel){
            state.importChannels = checked ? (uniquePush(state.importChannels, id), state.importChannels) : removeFromArr(state.importChannels, id);
          }else{
            state.importAccounts = checked ? (uniquePush(state.importAccounts, id), state.importAccounts) : removeFromArr(state.importAccounts, id);
          }
          renderImportChips();
        });
      });
    }

    function filterImportChannels(keyword){
      const kw = keyword.trim();
      const list = state.importSources.channels;
      if(!kw) return list;
      return list.filter(x => contains(x.code, kw));
    }
    function filterImportAccounts(keyword){
      const kw = keyword.trim();
      const list = state.importSources.accounts;
      if(!kw) return list;
      return list.filter(x => contains(x.name, kw));
    }

    function searchImportChannels(){
      const kw = $("import_channel_kw").value.trim();
      state.importChannelResults = filterImportChannels(kw);
      renderImportResults("channel");
    }
    function searchImportAccounts(){
      const kw = $("import_account_kw").value.trim();
      state.importAccountResults = filterImportAccounts(kw);
      renderImportResults("account");
    }
    function selectAllImportChannels(){
      state.importChannelResults.forEach(it => uniquePush(state.importChannels, it.id));
      renderImportChips();
      renderImportResults("channel");
    }
    function selectAllImportAccounts(){
      state.importAccountResults.forEach(it => uniquePush(state.importAccounts, it.id));
      renderImportChips();
      renderImportResults("account");
    }
    function clearImportChannels(){
      state.importChannels = [];
      renderImportChips();
      renderImportResults("channel");
    }
    function clearImportAccounts(){
      state.importAccounts = [];
      renderImportChips();
      renderImportResults("account");
    }

    function openImport(){
      buildImportSources();
      state.importChannels = [];
      state.importAccounts = [];
      state.importChannelResults = [];
      state.importAccountResults = [];
      $("import_channel_kw").value = "";
      $("import_account_kw").value = "";
      $("import_file").value = "";
      renderImportChips();
      searchImportChannels();
      searchImportAccounts();
      openModal("importMask");
    }

    function removeImportChannel(id){
      state.importChannels = removeFromArr(state.importChannels, id);
      renderImportChips();
      renderImportResults("channel");
    }
    function removeImportAccount(id){
      state.importAccounts = removeFromArr(state.importAccounts, id);
      renderImportChips();
      renderImportResults("account");
    }

    function submitImport(){
      const file = $("import_file").files?.[0];
      if(state.importChannels.length === 0){
        alert("请至少选择一个通道编码（可多选）。");
        return;
      }
      if(state.importAccounts.length === 0){
        alert("请至少选择一个账号（可多选）。");
        return;
      }
      if(!file){
        alert("请上传导入文件（xlsx/xls/csv）。");
        return;
      }

      alert(
        "已提交导入（演示）\n" +
        "通道编码：" + state.importChannels.join(", ") + "\n" +
        "账号：" + state.importAccounts.map(getAccountLabel).join(", ") + "\n" +
        "文件：" + file.name
      );
      closeModal("importMask");
    }

    // --------------------------
    // Export CSV (demo)
    // --------------------------
    function exportCsv(){
      const rows = state.filtered.length ? state.filtered : state.rows;
      const header = ["序号","通道编码","接入号编码","签名","扩展码","手机号","链接","发送类型","是否启用","备注","任务ID","操作时间"];
      const lines = [header.join(",")];
      rows.forEach((r, i) => {
        const line = [
          i+1, r.channelCode, r.accessNoCode, r.signature, r.extCode, r.phone,
          r.link, r.sendType, r.enabled ? "是":"否", r.remark || "", r.taskId || "", r.opTime || ""
        ].map(csvEscape).join(",");
        lines.push(line);
      });

      const blob = new Blob(["\ufeff" + lines.join("\n")], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "导出.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
    function csvEscape(v){
      const s = String(v ?? "");
      if(/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
      return s;
    }

    // --------------------------
    // One-click Test
    // --------------------------
    function openTest(){
      // 当前测试条数 = 当前筛选结果数（若未筛选则=全量）
      const list = state.filtered.length ? state.filtered : state.rows;
      state.test.count = list.length;
      $("testCountBadge").textContent = `当前测试 ${state.test.count} 条`;

      // 给每个运营商卡片回显 test state
      document.querySelectorAll(".carrier-card").forEach(card => {
        const carrier = card.getAttribute("data-carrier");
        const cfg = state.test.carriers[carrier] || { shortLink:false, shortTitle:"", content:"", suffix:"", phones:[] };

        card.querySelector(".shortlinkToggle").checked = !!cfg.shortLink;
        card.querySelector(".shortlinkTitle").value = cfg.shortTitle || "";
        card.querySelector(".msgContent").value = cfg.content || "";
        card.querySelector(".msgSuffix").value = cfg.suffix || "";
        card.querySelector(".phoneInput").value = "";

        renderPhoneChips(card, cfg.phones || []);
      });

      openModal("testMask");
    }

    function renderPhoneChips(card, phones){
      const wrap = card.querySelector(".phoneChips");
      if(!phones.length){
        wrap.innerHTML = `<span class="muted" style="font-size:12px;">未添加测试号码</span>`;
        return;
      }
      wrap.innerHTML = phones.map(p => `
        <span class="phone-chip">
          ${escapeHtml(p)}
          <button title="移除" data-phone="${escapeAttr(p)}">×</button>
        </span>
      `).join("");
      wrap.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          const carrier = card.getAttribute("data-carrier");
          const phone = btn.getAttribute("data-phone");
          state.test.carriers[carrier].phones = state.test.carriers[carrier].phones.filter(x => x !== phone);
          renderPhoneChips(card, state.test.carriers[carrier].phones);
        });
      });
    }

    function parsePhones(raw){
      return String(raw || "")
        .split(/[\s,，]+/)
        .map(s => s.trim())
        .filter(Boolean);
    }

    function bindTestEvents(){
      document.querySelectorAll(".carrier-card").forEach(card => {
        const carrier = card.getAttribute("data-carrier");
        if(!state.test.carriers[carrier]) state.test.carriers[carrier] = { shortLink:false, shortTitle:"", content:"", suffix:"", phones:[] };

        // add phones
        card.querySelector(".addPhoneBtn").addEventListener("click", () => {
          const input = card.querySelector(".phoneInput");
          const arr = parsePhones(input.value);
          if(!arr.length) return;

          const set = new Set(state.test.carriers[carrier].phones);
          arr.forEach(p => set.add(p));
          state.test.carriers[carrier].phones = Array.from(set);

          input.value = "";
          renderPhoneChips(card, state.test.carriers[carrier].phones);
        });

        // live save fields
        card.querySelector(".shortlinkToggle").addEventListener("change", (e) => {
          state.test.carriers[carrier].shortLink = e.target.checked;
        });
        card.querySelector(".shortlinkTitle").addEventListener("input", (e) => {
          state.test.carriers[carrier].shortTitle = e.target.value;
        });
        card.querySelector(".msgContent").addEventListener("input", (e) => {
          state.test.carriers[carrier].content = e.target.value;
        });
        card.querySelector(".msgSuffix").addEventListener("input", (e) => {
          state.test.carriers[carrier].suffix = e.target.value;
        });
      });
    }

    function submitTest(){
      const list = state.filtered.length ? state.filtered : state.rows;
      const count = list.length;

      // 简单校验：至少一个运营商有号码
      const anyPhones = Object.values(state.test.carriers).some(c => (c.phones || []).length > 0);
      if(!anyPhones){
        alert("请至少为一个运营商添加测试号码。");
        return;
      }

      alert(
        "已提交测试（演示）\n" +
        `测试范围：${count} 条（当前筛选结果）\n` +
        "测试配置：" + $("test_profile").value
      );
      closeModal("testMask");
    }

    // --------------------------
    // Init / wiring
    // --------------------------
    function init(){
      switchMain(currentMain);
      switchSub(currentSub);

      document.querySelectorAll(".main-nav-btn[data-main]").forEach(btn => {
        btn.addEventListener("click", () => {
          switchMain(btn.getAttribute("data-main"));
        });
      });
      document.querySelectorAll(".sub-tab-btn[data-sub]").forEach(btn => {
        btn.addEventListener("click", () => switchSub(btn.getAttribute("data-sub")));
      });

      loadSxTables();
      renderAccountTable();
      renderChannelTable();
      channelMapState.filtered = [...channelMapState.rows];
      renderChannelMap();

      // initial render
      applyFilters();

      $("btn_search").addEventListener("click", applyFilters);
      $("btn_reset").addEventListener("click", resetFilters);

      $("btn_import").addEventListener("click", openImport);
      $("btn_export").addEventListener("click", exportCsv);
      $("btn_test").addEventListener("click", openTest);

      // table ops delegate
      $("tbody").addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-op]");
        if(!btn) return;
        const tr = e.target.closest("tr");
        const id = tr?.getAttribute("data-id");
        if(!id) return;
        const op = btn.getAttribute("data-op");
        if(op === "edit") openEdit(id);
        if(op === "del") deleteRow(id);
      });

      // modal close buttons
      document.querySelectorAll("[data-close]").forEach(el => {
        el.addEventListener("click", () => closeModal(el.getAttribute("data-close")));
      });
      // click mask close
      ["importMask","editMask","testMask","modalAccount","modalChannel"].forEach(mid => {
        $(mid).addEventListener("click", (e) => {
          if(e.target.id === mid) closeModal(mid);
        });
      });

      // sx 账号表
      $("btn_add_account").addEventListener("click", () => openAccountModal("create"));
      $("acc_save").addEventListener("click", saveAccount);
      $("sx_account_tbody").addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-op]");
        if(!btn) return;
        const tr = e.target.closest("tr");
        const id = tr?.getAttribute("data-id");
        if(!id) return;
        const op = btn.getAttribute("data-op");
        if(op === "edit") openAccountModal("edit", id);
        if(op === "del") deleteAccount(id);
      });

      // sx 通道表
      $("btn_add_channel").addEventListener("click", () => openChannelModal("create"));
      $("channel_save").addEventListener("click", saveChannel);
      $("sx_channel_tbody").addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-op]");
        if(!btn) return;
        const tr = e.target.closest("tr");
        const code = tr?.getAttribute("data-code");
        if(!code) return;
        const op = btn.getAttribute("data-op");
        if(op === "edit") openChannelModal("edit", code);
        if(op === "del") deleteChannel(code);
      });

      // 通道管理默认子页（接入号产品映射）
      $("cm_search").addEventListener("click", () => {
        channelMapState.keyword = $("cm_kw").value;
        filterChannelMap();
      });
      $("cm_reset").addEventListener("click", () => {
        $("cm_kw").value = "";
        channelMapState.keyword = "";
        filterChannelMap();
      });
      $("cm_tbody").addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-op='edit']");
        if(!btn) return;
        const tr = btn.closest("tr");
        const id = tr?.getAttribute("data-id");
        const row = channelMapState.rows.find(x => x.id === id);
        if(!row) return;
        alert(`演示：编辑映射\n接入号：${row.accessNo}\n产品编码：${row.productCode}`);
      });
      $("cm_add").addEventListener("click", () => {
        alert("演示：新增映射（请接入表单/弹窗）");
      });

      // edit
      $("edit_save").addEventListener("click", saveEdit);
      $("e_remark").addEventListener("input", () => {
        $("remarkCount").textContent = ($("e_remark").value || "").length;
      });

      // import
      $("import_channel_search").addEventListener("click", searchImportChannels);
      $("import_account_search").addEventListener("click", searchImportAccounts);
      $("import_channel_selectall").addEventListener("click", selectAllImportChannels);
      $("import_account_selectall").addEventListener("click", selectAllImportAccounts);
      $("import_channel_clear").addEventListener("click", clearImportChannels);
      $("import_account_clear").addEventListener("click", clearImportAccounts);
      $("import_channel_kw").addEventListener("keydown", (e) => {
        if(e.key === "Enter"){ e.preventDefault(); searchImportChannels(); }
      });
      $("import_account_kw").addEventListener("keydown", (e) => {
        if(e.key === "Enter"){ e.preventDefault(); searchImportAccounts(); }
      });
      $("import_submit").addEventListener("click", submitImport);
      $("download_tpl").addEventListener("click", () => {
        alert("示例：这里可替换为真实模板下载链接（后端提供文件地址）");
      });

      // test
      bindTestEvents();
      $("btn_submit_test").addEventListener("click", submitTest);
      $("btn_submit_test_2").addEventListener("click", submitTest);
      $("btn_collapse_test").addEventListener("click", () => closeModal("testMask"));
    }

    init();
  </script>
</body>
</html>
