<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>接入号编码签名报备 - 列表</title>
  <style>
    :root{
      --bg:#f5f7fb;
      --card:#fff;
      --text:#1f2937;
      --muted:#6b7280;
      --line:#e5e7eb;
      --primary:#10b981;
      --primary2:#0ea371;
      --blue:#2563eb;
      --danger:#ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius: 12px;
      --radius2: 10px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
      color:var(--text);
      background:var(--bg);
    }
    .page{
      max-width: 1400px;
      margin: 22px auto;
      padding: 0 16px 40px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* Filter */
    .filter{
      padding: 18px 18px 12px;
    }
    .filter-grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(220px, 1fr));
      gap: 12px 16px;
      align-items:end;
    }
    .field label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 6px;
    }
    .input, .select, .textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      background:#fff;
      outline:none;
      font-size: 13px;
    }
    .textarea{ min-height: 90px; resize: vertical; }
    .input:focus, .select:focus, .textarea:focus{
      border-color: rgba(16,185,129,.6);
      box-shadow: 0 0 0 3px rgba(16,185,129,.15);
    }
    .hint-inline{
      font-size: 12px;
      color: var(--muted);
      padding: 10px 0 0;
      white-space: nowrap;
    }
    .filter-actions{
      display:flex;
      gap: 10px;
      justify-content:flex-end;
      align-items:center;
    }

    /* Buttons */
    .btn{
      border:1px solid var(--line);
      background:#fff;
      color: var(--text);
      border-radius: 10px;
      padding: 9px 14px;
      font-size: 13px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn:hover{ background:#f9fafb; }
    .btn-primary{
      border-color: transparent;
      background: var(--primary);
      color:#fff;
    }
    .btn-primary:hover{ background: var(--primary2); }
    .btn-danger{
      border-color: rgba(239,68,68,.25);
      color: var(--danger);
      background: rgba(239,68,68,.06);
    }
    .btn-danger:hover{ background: rgba(239,68,68,.10); }
    .btn-blue{
      border-color: transparent;
      background: var(--blue);
      color:#fff;
    }
    .btn-blue:hover{ filter: brightness(.95); }
    .btn-ghost{ background:transparent; }

    /* Toolbar */
    .toolbar{
      display:flex;
      gap: 10px;
      padding: 12px 18px;
      border-top: 1px solid var(--line);
      border-bottom: 1px solid var(--line);
      background:#fff;
      align-items:center;
    }
    .toolbar .spacer{ flex:1; }
    .muted{ color: var(--muted); }
    .stat{
      font-size: 12px;
      color: var(--muted);
    }
    .stat strong{ color:#111827; }

    /* Table */
    .table-wrap{
      overflow:auto;
      background:#fff;
    }
    table{
      width:100%;
      border-collapse: collapse;
      min-width: 1350px;
    }
    thead th{
      background:#fff;
      border-bottom: 1px solid var(--line);
      font-size: 12px;
      color:#374151;
      text-align:left;
      padding: 12px 12px;
      white-space: nowrap;
    }
    tbody td{
      border-bottom: 1px solid var(--line);
      padding: 12px 12px;
      font-size: 13px;
      vertical-align: top;
      white-space: nowrap;
    }
    tbody tr:hover{ background:#f9fafb; }
    a.link{
      color: var(--blue);
      text-decoration:none;
    }
    a.link:hover{ text-decoration:underline; }

    .pill{
      display:inline-flex;
      align-items:center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid var(--line);
      background:#fff;
    }
    .pill.on{ border-color: rgba(16,185,129,.35); background: rgba(16,185,129,.08); color: #0f766e; }
    .pill.off{ border-color: rgba(107,114,128,.35); background: rgba(107,114,128,.08); color: #374151; }

    .ops{
      display:flex;
      gap: 8px;
    }

    /* Modal */
    .modal-mask{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:flex-start;
      justify-content:center;
      padding: 18px;
      z-index: 30;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .modal{
      width: min(920px, 96vw);
      background:#fff;
      border-radius: 12px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(229,231,235,.8);
      overflow:hidden;
      max-height: calc(100vh - 36px);
      display:flex;
      flex-direction: column;
    }
    .modal-header{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--line);
      background:#fff;
    }
    .modal-title{
      font-weight: 600;
    }
    .modal-close{
      border:none;
      background:transparent;
      font-size: 18px;
      cursor:pointer;
      color: var(--muted);
    }
    .modal-body{
      padding: 16px;
      overflow:auto;
      flex: 1 1 auto;
      min-height: 0;
    }
    .modal-footer{
      padding: 14px 16px;
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      border-top:1px solid var(--line);
      background:#fff;
    }
    .form-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(240px, 1fr));
      gap: 12px 16px;
    }
    .full{ grid-column: 1 / -1; }

    /* Chips multi-select */
    .chips{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 8px 10px;
      border:1px solid var(--line);
      border-radius: 10px;
      min-height: 42px;
      background:#fff;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      background:#fff;
    }
    .chip button{
      border:none;
      background:transparent;
      cursor:pointer;
      color: var(--muted);
      font-size: 14px;
      line-height: 1;
    }
    .select-row{
      display:flex;
      gap: 10px;
      align-items:center;
    }
    .select-row .select{ flex:1; }

    .hint{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.6;
    }
    .hint ul{ margin: 6px 0 0 18px; }

    /* Test modal */
    .test-topbar{
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .test-topbar .spacer{ flex:1; }
    .badge{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(37,99,235,.08);
      border: 1px solid rgba(37,99,235,.25);
      color: #1d4ed8;
      font-size: 12px;
    }
    .section{
      border:1px solid var(--line);
      border-radius: 12px;
      padding: 14px;
      background:#fff;
      margin-top: 14px;
    }
    .section-title{
      font-weight: 600;
      margin-bottom: 4px;
    }
    .section-sub{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 12px;
    }
    .carrier-card{
      border:1px solid var(--line);
      border-radius: 12px;
      padding: 14px;
      margin-top: 12px;
      background:#fff;
    }
    .carrier-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .carrier-name{
      font-weight: 600;
    }
    .inline{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .toggle{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      font-size: 13px;
      color:#374151;
      user-select:none;
    }
    .toggle input{ transform: translateY(1px); }
    .small{ width: 240px; }
    .mini{
      padding: 8px 10px;
      border-radius: 10px;
      border:1px solid var(--line);
      font-size: 13px;
      outline:none;
    }
    .phone-add{
      display:flex;
      gap: 8px;
      align-items:center;
      flex-wrap: wrap;
    }
    .phone-add input{ width: 280px; }
    .phones{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .phone-chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background:#f3f4f6;
      border:1px solid var(--line);
      font-size: 12px;
    }
    .phone-chip button{
      border:none;
      background:transparent;
      cursor:pointer;
      color: var(--muted);
      font-size: 14px;
      line-height: 1;
    }

    @media (max-width: 1100px){
      .filter-grid{ grid-template-columns: repeat(2, minmax(220px, 1fr)); }
      .form-grid{ grid-template-columns: 1fr; }
      table{ min-width: 1200px; }
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="card">

      <!-- Filters -->
      <div class="filter">
        <div class="filter-grid">
          <div class="field">
            <label>通道编码（精准）</label>
            <input id="f_channel" class="input" placeholder="请输入通道编码" />
          </div>
          <div class="field">
            <label>签名（模糊）</label>
            <input id="f_signature" class="input" placeholder="请输入签名关键字" />
          </div>
          <div class="field">
            <label>扩展码（精准）</label>
            <input id="f_ext" class="input" placeholder="请输入扩展码" />
          </div>
          <div class="field">
            <label>手机号（精准）</label>
            <input id="f_phone" class="input" placeholder="请输入手机号" />
          </div>

          <div class="field">
            <label>链接（模糊）</label>
            <input id="f_link" class="input" placeholder="请输入链接关键字" />
          </div>
          <div class="field">
            <label>发送类型</label>
            <select id="f_sendType" class="select">
              <option value="">全部</option>
              <option value="行销">行销</option>
              <option value="行业">行业</option>
              <option value="营销">营销</option>
            </select>
          </div>
          <div class="field">
            <label>任务ID（精准）</label>
            <input id="f_taskId" class="input" placeholder="请输入任务ID" />
          </div>

          <div class="field">
            <div class="filter-actions">
              <button class="btn btn-primary" id="btn_search">查询</button>
              <button class="btn" id="btn_reset">重置</button>
            </div>
            <div class="hint-inline">支持：精准/模糊筛选（按你的定义）</div>
          </div>
        </div>
      </div>

      <!-- Toolbar -->
      <div class="toolbar">
        <button class="btn btn-primary" id="btn_import">导入</button>
        <button class="btn" id="btn_export">导出</button>
        <button class="btn btn-blue" id="btn_test">一键测试</button>
        <div class="spacer"></div>
        <div class="stat">数据条数：<strong id="count">0</strong></div>
      </div>

      <!-- Table -->
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:60px;">序号</th>
              <th>通道编码</th>
              <th>接入号编码</th>
              <th>签名</th>
              <th>扩展码</th>
              <th>手机号</th>
              <th>链接</th>
              <th>发送类型</th>
              <th>是否启用</th>
              <th>备注</th>
              <th>任务ID</th>
              <th>操作时间</th>
              <th style="width:160px;">操作</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

    </div>
  </div>

  <!-- Import Modal -->
  <div class="modal-mask" id="importMask" aria-hidden="true">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">导入</div>
        <button class="modal-close" data-close="importMask">✕</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="field">
            <label>选择通道编码（多选）</label>
            <div class="select-row">
              <select id="import_channel_select" class="select">
                <option value="" selected>请选择</option>
              </select>
              <button class="btn" id="import_add_channel">添加</button>
            </div>
            <div class="chips" id="import_channel_chips"></div>
          </div>

          <div class="field">
            <label>选择账号（多选）</label>
            <div class="select-row">
              <select id="import_account_select" class="select">
                <option value="" selected>请选择</option>
                <option value="账号A">账号A</option>
                <option value="账号B">账号B</option>
                <option value="账号C">账号C</option>
              </select>
              <button class="btn" id="import_add_account">添加</button>
            </div>
            <div class="chips" id="import_account_chips"></div>
          </div>

          <div class="field full">
            <label>导入文件</label>
            <input id="import_file" type="file" class="input" accept=".xlsx,.xls,.csv" />
            <div class="hint">
              点击下载：<a class="link" href="javascript:void(0)" id="download_tpl">接入号编码报备范例.xlsx</a>
              <ul>
                <li>请上传 xlsx/xls/csv 格式（演示页面不解析，仅做交互展示）</li>
                <li>excel 单元格格式请勿使用“常规”或“文本”以外格式（提示文案示意）</li>
                <li>单次导入建议不超过 10000 条（提示文案示意）</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" data-close="importMask">取消</button>
        <button class="btn btn-primary" id="import_submit">提交</button>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal-mask" id="editMask" aria-hidden="true">
    <div class="modal" style="width:min(760px, 96vw);">
      <div class="modal-header">
        <div class="modal-title">编辑</div>
        <button class="modal-close" data-close="editMask">✕</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="field">
            <label>接入号编码（不可编辑）</label>
            <input id="e_accessNo" class="input" disabled />
          </div>
          <div class="field">
            <label>签名（不可编辑）</label>
            <input id="e_signature" class="input" disabled />
          </div>
          <div class="field">
            <label>扩展码（不可编辑）</label>
            <input id="e_ext" class="input" disabled />
          </div>

          <div class="field">
            <label>发送类型（可编辑）</label>
            <select id="e_sendType" class="select">
              <option value="行销">行销</option>
              <option value="行业">行业</option>
              <option value="营销">营销</option>
            </select>
          </div>

          <div class="field">
            <label>是否启用（可编辑）</label>
            <select id="e_enabled" class="select">
              <option value="true">是</option>
              <option value="false">否</option>
            </select>
          </div>

          <div class="field full">
            <label>备注（可编辑）</label>
            <textarea id="e_remark" class="textarea" placeholder="请输入备注（可选）" maxlength="200"></textarea>
            <div class="muted" style="font-size:12px; margin-top:6px; text-align:right;">
              <span id="remarkCount">0</span>/200
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" data-close="editMask">取消</button>
        <button class="btn btn-primary" id="edit_save">确定</button>
      </div>
    </div>
  </div>

  <!-- Test Modal -->
  <div class="modal-mask" id="testMask" aria-hidden="true">
    <div class="modal" style="width:min(1100px, 96vw);">
      <div class="modal-header">
        <div class="test-topbar" style="width:100%;">
          <div>
            <div class="modal-title">测试</div>
            <div class="muted" style="font-size:12px; margin-top:4px;">选择测试配置并提交批量测试（演示）</div>
          </div>
          <div class="spacer"></div>
          <span class="badge" id="testCountBadge">当前测试 0 条</span>
          <button class="btn" id="btn_collapse_test">收起测试</button>
          <button class="btn btn-blue" id="btn_submit_test">提交测试</button>
          <button class="modal-close" data-close="testMask" title="关闭">✕</button>
        </div>
      </div>

      <div class="modal-body">
        <div class="section">
          <div class="section-title">测试配置</div>
          <div class="section-sub">选择测试配置后可编辑每个运营商的测试参数</div>

          <div class="form-grid">
            <div class="field">
              <label>测试配置</label>
              <select id="test_profile" class="select">
                <option value="通用测试">通用测试</option>
                <option value="短链测试">短链测试</option>
                <option value="高频测试">高频测试</option>
              </select>
            </div>
            <div class="field">
              <label>通用测试</label>
              <div class="muted" style="padding:10px 0 0;">无（演示占位）</div>
            </div>
          </div>
        </div>

        <!-- Carriers -->
        <div class="carrier-card" data-carrier="移动">
          <div class="carrier-head">
            <div>
              <div class="carrier-name">移动</div>
              <div class="muted" style="font-size:12px;">运营商编码：1</div>
            </div>
            <div class="inline">
              <label class="toggle"><input type="checkbox" class="shortlinkToggle" /> 启用短链</label>
              <input class="mini shortlinkTitle small" placeholder="短链标题" />
            </div>
          </div>

          <div class="form-grid">
            <div class="field full">
              <label>消息内容</label>
              <textarea class="textarea msgContent" placeholder="请输入消息内容"></textarea>
            </div>
            <div class="field full">
              <label>消息后缀</label>
              <input class="input msgSuffix" placeholder="例如：拒收请回复R" />
            </div>
          </div>

          <div class="field" style="margin-top:12px;">
            <label>测试电话号码</label>
            <div class="phone-add">
              <input class="input phoneInput" placeholder="输入号码，逗号/空格分隔" />
              <button class="btn addPhoneBtn">添加</button>
            </div>
            <div class="phones phoneChips"></div>
          </div>
        </div>

        <div class="carrier-card" data-carrier="联通">
          <div class="carrier-head">
            <div>
              <div class="carrier-name">联通</div>
              <div class="muted" style="font-size:12px;">运营商编码：2</div>
            </div>
            <div class="inline">
              <label class="toggle"><input type="checkbox" class="shortlinkToggle" /> 启用短链</label>
              <input class="mini shortlinkTitle small" placeholder="短链标题" />
            </div>
          </div>

          <div class="form-grid">
            <div class="field full">
              <label>消息内容</label>
              <textarea class="textarea msgContent" placeholder="请输入消息内容"></textarea>
            </div>
            <div class="field full">
              <label>消息后缀</label>
              <input class="input msgSuffix" placeholder="例如：拒收请回复R" />
            </div>
          </div>

          <div class="field" style="margin-top:12px;">
            <label>测试电话号码</label>
            <div class="phone-add">
              <input class="input phoneInput" placeholder="输入号码，逗号/空格分隔" />
              <button class="btn addPhoneBtn">添加</button>
            </div>
            <div class="phones phoneChips"></div>
          </div>
        </div>

        <div class="carrier-card" data-carrier="电信">
          <div class="carrier-head">
            <div>
              <div class="carrier-name">电信</div>
              <div class="muted" style="font-size:12px;">运营商编码：3</div>
            </div>
            <div class="inline">
              <label class="toggle"><input type="checkbox" class="shortlinkToggle" /> 启用短链</label>
              <input class="mini shortlinkTitle small" placeholder="短链标题" />
            </div>
          </div>

          <div class="form-grid">
            <div class="field full">
              <label>消息内容</label>
              <textarea class="textarea msgContent" placeholder="请输入消息内容"></textarea>
            </div>
            <div class="field full">
              <label>消息后缀</label>
              <input class="input msgSuffix" placeholder="例如：拒收请回复R" />
            </div>
          </div>

          <div class="field" style="margin-top:12px;">
            <label>测试电话号码</label>
            <div class="phone-add">
              <input class="input phoneInput" placeholder="输入号码，逗号/空格分隔" />
              <button class="btn addPhoneBtn">添加</button>
            </div>
            <div class="phones phoneChips"></div>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn" data-close="testMask">关闭</button>
        <button class="btn btn-blue" id="btn_submit_test_2">提交测试</button>
      </div>
    </div>
  </div>

  <script>
    // --------------------------
    // Mock data
    // --------------------------
    const DATA = [
      {
        id: crypto.randomUUID(),
        channelCode: "YZ",
        accessNoCode: "1QG106828164",
        signature: "【鹿城区南浦李金燕服装店】",
        extCode: "8000102068",
        phone: "13800001111",
        link: "https://example.com/a?src=yz",
        sendType: "行销",
        enabled: true,
        remark: "首批导入",
        taskId: "T-20251230-001",
        opTime: "2025-12-30 10:18:22",
      },
      {
        id: crypto.randomUUID(),
        channelCode: "YZ",
        accessNoCode: "1QG106848241",
        signature: "【鹿城区南浦李金燕服装店】",
        extCode: "8000102068",
        phone: "13800002222",
        link: "https://example.com/b",
        sendType: "行业",
        enabled: true,
        remark: "-",
        taskId: "T-20251230-002",
        opTime: "2025-12-30 09:11:02",
      },
      {
        id: crypto.randomUUID(),
        channelCode: "DX",
        accessNoCode: "AC-99887766",
        signature: "【XX有限公司】",
        extCode: "9000100001",
        phone: "13912345678",
        link: "https://landing.example.com/promo",
        sendType: "营销",
        enabled: true,
        remark: "渠道DX测试",
        taskId: "T-20251229-009",
        opTime: "2025-12-29 16:44:01",
      },
      {
        id: crypto.randomUUID(),
        channelCode: "LT",
        accessNoCode: "LT-11223344",
        signature: "【某门店】",
        extCode: "7000123456",
        phone: "13711112222",
        link: "https://example.com/store",
        sendType: "行销",
        enabled: false,
        remark: "长期",
        taskId: "T-20251228-003",
        opTime: "2025-12-28 09:12:45",
      },
    ];

    let state = {
      rows: [...DATA],
      filtered: [],
      editingId: null,
      importChannels: [],
      importAccounts: [],
      // test state
      test: {
        count: 0,
        carriers: {
          "移动": { shortLink:false, shortTitle:"", content:"测试", suffix:"拒收请回复R", phones:["15735106554","18340756179","15110302313","15010298912"] },
          "联通": { shortLink:false, shortTitle:"", content:"测试", suffix:"拒收请回复R", phones:["18634348313"] },
          "电信": { shortLink:false, shortTitle:"", content:"测试", suffix:"拒收请回复R", phones:[] },
        }
      }
    };

    // --------------------------
    // Helpers
    // --------------------------
    const $ = (id) => document.getElementById(id);

    function contains(hay, needle){
      return String(hay ?? "").toLowerCase().includes(String(needle ?? "").toLowerCase());
    }
    function equals(a,b){
      return String(a ?? "") === String(b ?? "");
    }
    function fmtEnabled(v){
      return v ? `<span class="pill on">启用</span>` : `<span class="pill off">停用</span>`;
    }
    function shorten(s, n){
      s = String(s || "");
      if(s.length <= n) return s;
      return s.slice(0, n-1) + "…";
    }
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(str){ return escapeHtml(str); }

    // --------------------------
    // Render table
    // --------------------------
    function renderTable(rows){
      const tbody = $("tbody");
      tbody.innerHTML = rows.map((r, idx) => `
        <tr data-id="${r.id}">
          <td>${idx + 1}</td>
          <td>${escapeHtml(r.channelCode)}</td>
          <td>${escapeHtml(r.accessNoCode)}</td>
          <td title="${escapeHtml(r.signature)}">${escapeHtml(r.signature)}</td>
          <td>${escapeHtml(r.extCode)}</td>
          <td>${escapeHtml(r.phone)}</td>
          <td title="${escapeHtml(r.link)}">
            <a class="link" href="${escapeAttr(r.link)}" target="_blank" rel="noreferrer">${escapeHtml(shorten(r.link, 28))}</a>
          </td>
          <td>${escapeHtml(r.sendType)}</td>
          <td>${fmtEnabled(r.enabled)}</td>
          <td title="${escapeHtml(r.remark || "-")}">${escapeHtml(r.remark || "-")}</td>
          <td>${escapeHtml(r.taskId || "-")}</td>
          <td>${escapeHtml(r.opTime || "-")}</td>
          <td>
            <div class="ops">
              <button class="btn btn-ghost" data-op="edit">编辑</button>
              <button class="btn btn-danger" data-op="del">删除</button>
            </div>
          </td>
        </tr>
      `).join("");
      $("count").textContent = rows.length;
    }

    // --------------------------
    // Filtering logic
    // --------------------------
    function applyFilters(){
      const fChannel = $("f_channel").value.trim();
      const fSign = $("f_signature").value.trim();
      const fExt = $("f_ext").value.trim();
      const fPhone = $("f_phone").value.trim();
      const fLink = $("f_link").value.trim();
      const fSend = $("f_sendType").value.trim();
      const fTask = $("f_taskId").value.trim();

      const rows = state.rows.filter(r => {
        if (fChannel && !equals(r.channelCode, fChannel)) return false;  // 通道编码精准
        if (fExt && !equals(r.extCode, fExt)) return false;              // 扩展码精准
        if (fPhone && !equals(r.phone, fPhone)) return false;            // 手机号精准
        if (fSend && !equals(r.sendType, fSend)) return false;           // 发送类型下拉
        if (fTask && !equals(r.taskId, fTask)) return false;             // 任务ID精准
        if (fSign && !contains(r.signature, fSign)) return false;        // 签名模糊
        if (fLink && !contains(r.link, fLink)) return false;             // 链接模糊
        return true;
      });

      state.filtered = rows;
      renderTable(rows);
    }

    function resetFilters(){
      $("f_channel").value = "";
      $("f_signature").value = "";
      $("f_ext").value = "";
      $("f_phone").value = "";
      $("f_link").value = "";
      $("f_sendType").value = "";
      $("f_taskId").value = "";
      applyFilters();
    }

    // --------------------------
    // Modals
    // --------------------------
    function openModal(maskId){
      const el = $(maskId);
      el.style.display = "flex";
      el.setAttribute("aria-hidden","false");
    }
    function closeModal(maskId){
      const el = $(maskId);
      el.style.display = "none";
      el.setAttribute("aria-hidden","true");
    }

    // --------------------------
    // Edit flow
    // --------------------------
    function openEdit(id){
      const row = state.rows.find(x => x.id === id);
      if(!row) return;

      state.editingId = id;
      $("e_accessNo").value = row.accessNoCode;
      $("e_signature").value = row.signature;
      $("e_ext").value = row.extCode;
      $("e_sendType").value = row.sendType;
      $("e_enabled").value = String(row.enabled);
      $("e_remark").value = row.remark && row.remark !== "-" ? row.remark : "";
      $("remarkCount").textContent = ($("e_remark").value || "").length;

      openModal("editMask");
    }

    function saveEdit(){
      const id = state.editingId;
      const idx = state.rows.findIndex(x => x.id === id);
      if(idx < 0) return;

      state.rows[idx].sendType = $("e_sendType").value;
      state.rows[idx].enabled = $("e_enabled").value === "true";
      state.rows[idx].remark = $("e_remark").value.trim() || "-";
      state.rows[idx].opTime = new Date().toISOString().slice(0,19).replace("T"," ");

      closeModal("editMask");
      applyFilters();
    }

    // --------------------------
    // Delete flow
    // --------------------------
    function deleteRow(id){
      const row = state.rows.find(x => x.id === id);
      if(!row) return;

      const ok = confirm(`确认删除？\n接入号编码：${row.accessNoCode}\n签名：${row.signature}`);
      if(!ok) return;

      state.rows = state.rows.filter(x => x.id !== id);
      applyFilters();
    }

    // --------------------------
    // Import flow (demo)
    // --------------------------
    function initImportOptions(){
      const channels = Array.from(new Set(state.rows.map(r => r.channelCode))).sort();
      const sel = $("import_channel_select");
      sel.innerHTML = `<option value="" selected>请选择</option>` + channels.map(c => `<option value="${escapeAttr(c)}">${escapeHtml(c)}</option>`).join("");
    }

    function renderChips(containerId, items, onRemove){
      const el = $(containerId);
      if(items.length === 0){
        el.innerHTML = `<span class="muted" style="font-size:12px;">未选择</span>`;
        return;
      }
      el.innerHTML = items.map(v => `
        <span class="chip">
          ${escapeHtml(v)}
          <button title="移除" data-val="${escapeAttr(v)}">×</button>
        </span>
      `).join("");
      el.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => onRemove(btn.getAttribute("data-val")));
      });
    }

    function openImport(){
      initImportOptions();
      state.importChannels = [];
      state.importAccounts = [];
      $("import_file").value = "";
      renderChips("import_channel_chips", state.importChannels, removeImportChannel);
      renderChips("import_account_chips", state.importAccounts, removeImportAccount);
      openModal("importMask");
    }

    function addImportChannel(){
      const v = $("import_channel_select").value;
      if(!v) return;
      if(!state.importChannels.includes(v)) state.importChannels.push(v);
      renderChips("import_channel_chips", state.importChannels, removeImportChannel);
    }
    function addImportAccount(){
      const v = $("import_account_select").value;
      if(!v) return;
      if(!state.importAccounts.includes(v)) state.importAccounts.push(v);
      renderChips("import_account_chips", state.importAccounts, removeImportAccount);
    }
    function removeImportChannel(v){
      state.importChannels = state.importChannels.filter(x => x !== v);
      renderChips("import_channel_chips", state.importChannels, removeImportChannel);
    }
    function removeImportAccount(v){
      state.importAccounts = state.importAccounts.filter(x => x !== v);
      renderChips("import_account_chips", state.importAccounts, removeImportAccount);
    }

    function submitImport(){
      const file = $("import_file").files?.[0];
      if(state.importChannels.length === 0){
        alert("请至少选择一个通道编码（可多选）。");
        return;
      }
      if(state.importAccounts.length === 0){
        alert("请至少选择一个账号（可多选）。");
        return;
      }
      if(!file){
        alert("请上传导入文件（xlsx/xls/csv）。");
        return;
      }

      alert(
        "已提交导入（演示）\n" +
        "通道编码：" + state.importChannels.join(", ") + "\n" +
        "账号：" + state.importAccounts.join(", ") + "\n" +
        "文件：" + file.name
      );
      closeModal("importMask");
    }

    // --------------------------
    // Export CSV (demo)
    // --------------------------
    function exportCsv(){
      const rows = state.filtered.length ? state.filtered : state.rows;
      const header = ["序号","通道编码","接入号编码","签名","扩展码","手机号","链接","发送类型","是否启用","备注","任务ID","操作时间"];
      const lines = [header.join(",")];
      rows.forEach((r, i) => {
        const line = [
          i+1, r.channelCode, r.accessNoCode, r.signature, r.extCode, r.phone,
          r.link, r.sendType, r.enabled ? "是":"否", r.remark || "", r.taskId || "", r.opTime || ""
        ].map(csvEscape).join(",");
        lines.push(line);
      });

      const blob = new Blob(["\ufeff" + lines.join("\n")], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "导出.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
    function csvEscape(v){
      const s = String(v ?? "");
      if(/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
      return s;
    }

    // --------------------------
    // One-click Test
    // --------------------------
    function openTest(){
      // 当前测试条数 = 当前筛选结果数（若未筛选则=全量）
      const list = state.filtered.length ? state.filtered : state.rows;
      state.test.count = list.length;
      $("testCountBadge").textContent = `当前测试 ${state.test.count} 条`;

      // 给每个运营商卡片回显 test state
      document.querySelectorAll(".carrier-card").forEach(card => {
        const carrier = card.getAttribute("data-carrier");
        const cfg = state.test.carriers[carrier] || { shortLink:false, shortTitle:"", content:"", suffix:"", phones:[] };

        card.querySelector(".shortlinkToggle").checked = !!cfg.shortLink;
        card.querySelector(".shortlinkTitle").value = cfg.shortTitle || "";
        card.querySelector(".msgContent").value = cfg.content || "";
        card.querySelector(".msgSuffix").value = cfg.suffix || "";
        card.querySelector(".phoneInput").value = "";

        renderPhoneChips(card, cfg.phones || []);
      });

      openModal("testMask");
    }

    function renderPhoneChips(card, phones){
      const wrap = card.querySelector(".phoneChips");
      if(!phones.length){
        wrap.innerHTML = `<span class="muted" style="font-size:12px;">未添加测试号码</span>`;
        return;
      }
      wrap.innerHTML = phones.map(p => `
        <span class="phone-chip">
          ${escapeHtml(p)}
          <button title="移除" data-phone="${escapeAttr(p)}">×</button>
        </span>
      `).join("");
      wrap.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          const carrier = card.getAttribute("data-carrier");
          const phone = btn.getAttribute("data-phone");
          state.test.carriers[carrier].phones = state.test.carriers[carrier].phones.filter(x => x !== phone);
          renderPhoneChips(card, state.test.carriers[carrier].phones);
        });
      });
    }

    function parsePhones(raw){
      return String(raw || "")
        .split(/[\s,，]+/)
        .map(s => s.trim())
        .filter(Boolean);
    }

    function bindTestEvents(){
      document.querySelectorAll(".carrier-card").forEach(card => {
        const carrier = card.getAttribute("data-carrier");
        if(!state.test.carriers[carrier]) state.test.carriers[carrier] = { shortLink:false, shortTitle:"", content:"", suffix:"", phones:[] };

        // add phones
        card.querySelector(".addPhoneBtn").addEventListener("click", () => {
          const input = card.querySelector(".phoneInput");
          const arr = parsePhones(input.value);
          if(!arr.length) return;

          const set = new Set(state.test.carriers[carrier].phones);
          arr.forEach(p => set.add(p));
          state.test.carriers[carrier].phones = Array.from(set);

          input.value = "";
          renderPhoneChips(card, state.test.carriers[carrier].phones);
        });

        // live save fields
        card.querySelector(".shortlinkToggle").addEventListener("change", (e) => {
          state.test.carriers[carrier].shortLink = e.target.checked;
        });
        card.querySelector(".shortlinkTitle").addEventListener("input", (e) => {
          state.test.carriers[carrier].shortTitle = e.target.value;
        });
        card.querySelector(".msgContent").addEventListener("input", (e) => {
          state.test.carriers[carrier].content = e.target.value;
        });
        card.querySelector(".msgSuffix").addEventListener("input", (e) => {
          state.test.carriers[carrier].suffix = e.target.value;
        });
      });
    }

    function submitTest(){
      const list = state.filtered.length ? state.filtered : state.rows;
      const count = list.length;

      // 简单校验：至少一个运营商有号码
      const anyPhones = Object.values(state.test.carriers).some(c => (c.phones || []).length > 0);
      if(!anyPhones){
        alert("请至少为一个运营商添加测试号码。");
        return;
      }

      alert(
        "已提交测试（演示）\n" +
        `测试范围：${count} 条（当前筛选结果）\n` +
        "测试配置：" + $("test_profile").value
      );
      closeModal("testMask");
    }

    // --------------------------
    // Init / wiring
    // --------------------------
    function init(){
      // initial render
      applyFilters();

      $("btn_search").addEventListener("click", applyFilters);
      $("btn_reset").addEventListener("click", resetFilters);

      $("btn_import").addEventListener("click", openImport);
      $("btn_export").addEventListener("click", exportCsv);
      $("btn_test").addEventListener("click", openTest);

      // table ops delegate
      $("tbody").addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-op]");
        if(!btn) return;
        const tr = e.target.closest("tr");
        const id = tr?.getAttribute("data-id");
        if(!id) return;
        const op = btn.getAttribute("data-op");
        if(op === "edit") openEdit(id);
        if(op === "del") deleteRow(id);
      });

      // modal close buttons
      document.querySelectorAll("[data-close]").forEach(el => {
        el.addEventListener("click", () => closeModal(el.getAttribute("data-close")));
      });
      // click mask close
      ["importMask","editMask","testMask"].forEach(mid => {
        $(mid).addEventListener("click", (e) => {
          if(e.target.id === mid) closeModal(mid);
        });
      });

      // edit
      $("edit_save").addEventListener("click", saveEdit);
      $("e_remark").addEventListener("input", () => {
        $("remarkCount").textContent = ($("e_remark").value || "").length;
      });

      // import
      $("import_add_channel").addEventListener("click", addImportChannel);
      $("import_add_account").addEventListener("click", addImportAccount);
      $("import_submit").addEventListener("click", submitImport);
      $("download_tpl").addEventListener("click", () => {
        alert("示例：这里可替换为真实模板下载链接（后端提供文件地址）");
      });

      // test
      bindTestEvents();
      $("btn_submit_test").addEventListener("click", submitTest);
      $("btn_submit_test_2").addEventListener("click", submitTest);
      $("btn_collapse_test").addEventListener("click", () => closeModal("testMask"));
    }

    init();
  </script>
</body>
</html>
